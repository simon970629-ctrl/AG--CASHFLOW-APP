<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°¸é‘«è´¸æ˜“åˆä½œç¤¾æœ‰é™å…¬å¸ - AG ç°é‡‘æµæŠ¥è¡¨ V6.3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  :root {
    --bg-color: #fef9c3;
    --card-bg: #ffffff;
    --primary: #f59e0b; /* æ©™è‰² */
    --gold: #d97706; /* æ·±é‡‘è‰²ç”¨äºå“ç‰Œå */
    --danger: #dc2626;
    --success: #0d9488;
    --text-main: #1f2937;
    --text-sub: #6b7280;
    --border: #e5e7eb;
  }

  body {
    margin: 0; padding: 0;
    background-color: var(--bg-color);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color: var(--text-main);
    font-size: 14px;
  }

  .hidden { display: none !important; }
  .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
  
  .card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  h2, h3, h4 { margin: 0 0 10px 0; font-weight: 600; }
  h3 { font-size: 16px; color: var(--text-main); border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; margin-bottom: 15px;}
  
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;}
  .col { flex: 1; min-width: 150px; }
  
  label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
  input, select {
    width: 100%; box-sizing: border-box;
    padding: 8px; border: 1px solid var(--border);
    border-radius: 6px; font-size: 14px; outline: none;
  }
  input:focus, select:focus { border-color: var(--primary); }

  button {
    cursor: pointer; padding: 8px 16px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 500; transition: opacity 0.2s;
  }
  button:hover { opacity: 0.9; }
  button.primary { background: var(--primary); color: white; }
  button.danger { background: var(--danger); color: white; }
  button.teal { background: var(--success); color: white; }
  button.secondary { background: #e5e7eb; color: var(--text-main); }
  button.sm { padding: 4px 10px; font-size: 12px; }

  /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
  .acc-item {
    background: white; padding: 6px 8px; margin-bottom: 6px;
    border-radius: 4px; border: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; 
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .acc-item:hover { box-shadow: 0 0 0 2px var(--primary); } 
  .acc-item.selected { box-shadow: 0 0 0 3px var(--success); } 
  .acc-item.dragging { opacity: 0.5; background: #fef3c7; border: 1px dashed var(--primary); }
  .acc-item.drag-over { border-top: 2px solid var(--primary); }

  /* è´¦æˆ·åˆ—è¡¨å¸ƒå±€ (Grouped) */
  .acc-scroll { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 0; }
  .acc-group {
    flex: 1; min-width: 180px;
    background: #f9fafb; border: 1px solid var(--border);
    border-radius: 8px; padding: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .acc-group h4 { font-size: 14px; color: var(--text-main); text-align: center; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 5px;}
  .acc-bal { font-weight: bold; font-family: monospace; font-size: 13px; }
  .acc-bal.neg { color: var(--danger); }

  /* è¡¨æ ¼æ ·å¼ & å›ºå®šè¡¨å¤´ */
  .table-responsive { overflow-y: auto; max-height: 500px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; } 
  th, td { text-align: left; padding: 6px 5px; border-bottom: 1px solid var(--border); } 
  th { 
    background: #f9fafb; font-weight: 600; color: var(--text-sub); 
    position: sticky; top: 0; z-index: 10; 
  }
  tr:hover { background: #fffbe6; }

  /* Overlay and Modal */
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(254, 249, 195, 0.9); z-index: 1000; 
    display: flex; align-items: center; justify-content: center;
  }
  .overlay-box {
    background: white; padding: 30px; border-radius: 16px;
    width: 90%; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: center;
  }
  .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center; z-index: 2000;
  }
  .modal-content {
    background: white; padding: 20px; border-radius: 12px;
    width: 90%; max-width: 700px; 
    max-height: 90vh; overflow-y: auto;
  }

  /* ä¸šåŠ¡åˆ‡æ¢æ  */
  .business-switcher {
    display: flex; gap: 5px; margin-bottom: 15px;
    background: #e5e7eb; padding: 5px; border-radius: 8px;
  }
  .business-switcher button {
    flex: 1; background: transparent; color: var(--text-main); padding: 6px 12px; font-weight: 500;
  }
  .business-switcher button.active {
    background: var(--primary); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  
  /* Dashboard Card Link */
  .dash-grid { display: flex; gap: 10px; flex-wrap: wrap; }
  .dash-card { flex: 1; background: #fffbe6; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #fde68a; cursor: pointer; transition: background 0.2s;}
  .dash-card:hover { background: #fef3c7; }
  .dash-val { font-size: 20px; font-weight: bold; color: var(--text-main); margin-top: 5px; }

</style>
</head>
<body>

<div id="layer-import" class="overlay">
  <div class="overlay-box">
    <h2 style="color:var(--gold); margin-bottom:5px;">æ°¸é‘«è´¸æ˜“åˆä½œç¤¾æœ‰é™å…¬å¸</h2>
    <h3 style="color:var(--gold); border-bottom:none; margin-bottom:20px;">AlwaysGold Sdn. Bhd.</h3>
    <p style="color:var(--text-sub); margin-bottom:20px;">è¯·å¯¼å…¥ JSON å¤‡ä»½å¯åŠ¨ç³»ç»Ÿ</p>
    <button class="primary" onclick="triggerImport()">ğŸ“‚ å¯¼å…¥ JSON å¤‡ä»½æ–‡ä»¶</button>
    <input type="file" id="file-import" accept=".json" class="hidden" onchange="handleFileImport(this)">
  </div>
</div>

<div id="layer-login" class="overlay hidden">
  <div class="overlay-box">
    <h2 style="color:var(--gold); margin-bottom:5px;">æ°¸é‘«è´¸æ˜“åˆä½œç¤¾æœ‰é™å…¬å¸</h2>
    <h3 style="color:var(--gold); border-bottom:none; margin-bottom:20px;">AlwaysGold Sdn. Bhd.</h3>
    <h4 style="margin-top:-10px;">ç”¨æˆ·ç™»å½•</h4>
    <div style="text-align:left; margin-top:15px;">
      <label>ç”¨æˆ·å</label>
      <input type="text" id="login-user-input">
      <div style="height:10px;"></div>
      <label>å¯†ç </label>
      <input type="password" id="login-pass" onkeyup="if(event.key==='Enter') doLogin()">
    </div>
    <button class="primary" style="width:100%; margin-top:20px;" onclick="doLogin()">ç™»å½•ç³»ç»Ÿ</button>
    <p id="login-msg" style="color:var(--danger); font-size:12px; margin-top:10px;"></p>
  </div>
</div>

<div id="app" class="container hidden">
  
  <div class="top-bar">
    <div>
      <h2 style="margin:0;">AG è´¸æ˜“ç°é‡‘æµæŠ¥è¡¨ â€” V6.3</h2>
      <span style="font-size:12px; color:#666;">
        å‰¯æ ‡é¢˜ï¼šç°é‡‘ + é“¶è¡Œ Â· åº”æ”¶åº”ä»˜ Â· å‘˜å·¥å¾€æ¥ Â· æœ¬åœ°ä¿å­˜<br>
        æ“ä½œäºº: <b id="display-user"></b>
      </span>
    </div>
    <div style="display:flex; gap:5px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="secondary sm" onclick="showManager()">ğŸ‘¤ ç®¡ç†äººå‘˜</button>
      <button class="secondary sm" onclick="triggerImportBtn()">ğŸ“‚ å¯¼å…¥ JSON</button>
      <input type="file" id="file-import-btn" accept=".json" class="hidden" onchange="handleFileImport(this)">
      <button class="secondary sm" onclick="exportJSON()">ğŸ’¾ å¯¼å‡º JSON</button>
      <button class="secondary sm" onclick="exportCSV()">ğŸ“„ å¯¼å‡º CSV</button>
      <button class="secondary sm" onclick="exportPDF()">ğŸ“„ å¯¼å‡º PDF</button>
      <button class="danger sm" onclick="systemReset()"âš ï¸ ç³»ç»Ÿé‡ç½®</button>
      <button class="secondary sm" onclick="doLogout()">é€€å‡º</button>
    </div>
  </div>

  <div class="business-switcher">
    <button id="filter-ALL" class="active" onclick="setBusinessFilter('ALL')">å…¨éƒ¨ä¸šåŠ¡ (ALL)</button>
    <button id="filter-TRADE" onclick="setBusinessFilter('trade')">è´¸æ˜“ä¸šåŠ¡ (TRADE)</button>
    <button id="filter-TRANSPORT" onclick="setBusinessFilter('transport')">è¿è¾“ä¸šåŠ¡ (TRANSPORT)</button>
    <button id="filter-PLANTATION" onclick="setBusinessFilter('plantation')">ç§æ¤ä¸šåŠ¡ (PLANTATION)</button>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3>è´¢åŠ¡æ¦‚è§ˆ (ç‚¹å‡»å¡ç‰‡å¯æŸ¥çœ‹æ˜ç»†)</h3>
      <div>
        <button class="secondary sm" id="btn-rpt-day" onclick="renderReport('day')">ä»Šæ—¥</button>
        <button class="secondary sm" id="btn-rpt-week" onclick="renderReport('week')">æœ¬å‘¨</button>
        <button class="secondary sm" id="btn-rpt-month" onclick="renderReport('month')">æœ¬æœˆ</button>
      </div>
    </div>
    <div class="dash-grid">
      <div class="dash-card" id="card-in"><div>æ”¶å…¥</div><div class="dash-val" id="rpt-in" style="color:var(--success)">0.00</div></div>
      <div class="dash-card" id="card-out"><div>æ”¯å‡º</div><div class="dash-val" id="rpt-out" style="color:var(--danger)">0.00</div></div>
      <div class="dash-card" id="card-net"><div>å‡€ç°é‡‘æµ</div><div class="dash-val" id="rpt-net">0.00</div></div>
    </div>
  </div>

  <div class="card">
    <h3>å¿«é€Ÿæ“ä½œ</h3>
    <div class="action-bar">
      <button class="action-btn secondary" onclick="setMode('IN')">ğŸ’° æ”¶å…¥</button>
      <button class="action-btn secondary" onclick="setMode('OUT')">ğŸ’¸ æ”¯å‡º</button>
      <button class="action-btn secondary" onclick="setMode('AR_ADD')">ğŸ“ åº”æ”¶(æŒ‚è´¦)</button>
      <button class="action-btn teal" onclick="setMode('AR_GET')">âœ… æ”¶åº”æ”¶</button>
      <button class="action-btn secondary" onclick="setMode('AP_ADD')">ğŸ“ åº”ä»˜(èµŠè´¦)</button>
      <button class="action-btn danger" onclick="setMode('AP_PAY')">ğŸ§§ æ”¯ä»˜åº”ä»˜</button>
      <button class="action-btn secondary" onclick="setMode('TRANSFER')">ğŸ”„ è½¬è´¦</button>
      <button class="action-btn secondary" style="margin-left:auto;" onclick="setMode('OPEN_ACC')">â• å¼€æˆ·</button>
    </div>
    <div id="action-form" style="background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #e5e7eb;">
      <h4 id="form-title" style="color:var(--primary); margin-bottom:10px;">è¯·é€‰æ‹©æ“ä½œ...</h4>
      <div id="form-inputs" class="row"></div>
      <div style="margin-top:10px; text-align:right;">
        <button id="btn-submit" class="primary hidden" onclick="submitTransaction()">ç¡®è®¤æäº¤ (Enter)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>è´¦æˆ·åˆ—è¡¨ (æŒ‰ä¸šåŠ¡åˆ†ç»„)</h3>
    <p style="font-size:12px; color:#999; margin-top:-10px; margin-bottom:10px;">æç¤ºï¼šç‚¹å‡»è´¦æˆ·ç­›é€‰æ˜ç»†ï¼ŒæŒ‰ä½å¡ç‰‡å¯è¿›è¡Œæ‹–æ‹½æ’åº (é™åŒä¸€åˆ—)</p>
    <div class="acc-scroll" id="acc-list-container"></div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
      <h3>è´¦ç›®æ˜ç»†</h3> 
      <div class="row" style="flex:1; max-width:600px; margin-left:auto;">
          <div class="col" style="min-width:100px;"><label>èµ·å§‹æ—¥æœŸ</label><input type="date" id="filter-start-date" onchange="renderLedger()"></div>
          <div class="col" style="min-width:100px;"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="filter-end-date" onchange="renderLedger()"></div>
          <div class="col" style="min-width:150px;"><label>æœç´¢</label><input type="text" id="search-input" placeholder="æœç´¢è¯´æ˜/è´¦æˆ·å..." onkeyup="renderLedger()"></div>
          <div class="col" style="min-width:150px; flex:0 0 auto; display:flex; gap:5px;">
              <button class="secondary sm" style="align-self:flex-end;" onclick="clearAllFilters()">æ¸…ç©º</button>
              <button class="danger sm" style="align-self:flex-end;" onclick="deleteAllRecords()">åˆ é™¤å…¨éƒ¨</button>
          </div>
      </div>
    </div>
    <div class="table-responsive">
      <table id="ledger-table">
        <thead>
          <tr>
            <th style="width:10%;">æ—¥æœŸ</th>
            <th style="width:8%;">ç±»å‹</th>
            <th style="width:25%;">è¯´æ˜</th>
            <th style="width:10%;">ä¸»è´¦æˆ·</th>
            <th style="width:10%;">å¯¹æ–¹è´¦æˆ·</th>
            <th style="width:9%; color:var(--success)">æ”¶å…¥</th>
            <th style="width:9%; color:var(--danger)">æ”¯å‡º</th>
            <th style="width:9%;">æ“ä½œäºº</th>
            <th style="width:10%;">ç®¡ç†</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal-mgr" class="modal hidden">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>äººå‘˜ç®¡ç† (ä»…é™ç®¡ç†å‘˜)</h3>
        <p style="font-size:11px; color:var(--danger); margin:0;">âš ï¸ å¯†ç å»ºè®®é•¿åº¦ â‰¥ 6 ä½</p>
        <button class="secondary sm" onclick="document.getElementById('modal-mgr').classList.add('hidden')">å…³é—­</button>
    </div>
    <div class="row" style="background:#f3f4f6; padding:10px; border-radius:8px; margin-bottom:10px; margin-top:10px;">
      <div class="col"><label>å§“å</label><input id="new-u-name" placeholder="å§“å"></div>
      <div class="col"><label>ç”¨æˆ·å</label><input id="new-u-user" placeholder="ç”¨æˆ·å"></div>
      <div class="col"><label>è§’è‰²</label><select id="new-u-role"><option value="admin">ç³»ç»Ÿç®¡ç†å‘˜</option><option value="accountant">ä¼šè®¡</option><option value="shareholder">è‚¡ä¸œ</option><option value="agent">åŒºä»£ç†</option></select></div>
      <div class="col"><label>å¯†ç </label><input id="new-u-pass" type="password" placeholder="è®¾ç½®æ–°å¯†ç "></div>
      <div class="col" style="flex: 0 0 100px;"><button class="primary" style="width:100%; align-self:flex-end;" onclick="addUser()">æ·»åŠ </button></div>
    </div>
    <table id="user-table"><thead><tr><th>å§“å</th><th>ç”¨æˆ·å (è§’è‰²)</th><th>å¯†ç </th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<div id="modal-edit" class="modal hidden">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="edit-modal-title">ç¼–è¾‘äº¤æ˜“è®°å½• (ID: <span id="edit-entry-id"></span>)</h3>
        <button class="secondary sm" onclick="document.getElementById('modal-edit').classList.add('hidden')">å…³é—­</button>
    </div>
    <div class="row">
        <div class="col"><label>æ—¥æœŸ</label><input type="date" id="edit-date"></div>
        <div class="col"><label>ç±»å‹</label><select id="edit-type"></select></div>
        <div class="col"><label>æŸç›Šç±»åˆ«</label><select id="edit-plCategory"></select></div>
        <div class="col"><label>è¯´æ˜</label><input type="text" id="edit-desc"></div>
    </div>
    <div class="row" style="margin-top:10px;">
        <div class="col"><label>ä¸»è´¦æˆ·</label><select id="edit-mainId"></select></div>
        <div class="col"><label>å¯¹æ–¹è´¦æˆ·</label><select id="edit-otherId"></select></div>
        <div class="col"><label style="color:var(--success)">æ”¶å…¥ (Income)</label><input type="number" id="edit-income" value="0" min="0" step="0.01"></div>
        <div class="col"><label style="color:var(--danger)">æ”¯å‡º (Expense)</label><input type="number" id="edit-expense" value="0" min="0" step="0.01"></div>
    </div>
    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center; border-top: 1px solid var(--border); padding-top: 10px;">
        <p style="font-size:12px; color:var(--text-sub);">åŸæ“ä½œäºº: <span id="edit-original-operator"></span> | æœ€åç¼–è¾‘: <span id="edit-last-edit"></span></p>
        <div>
            <button class="danger" id="btn-delete-entry">å½»åº•åˆ é™¤</button>
            <button class="primary" onclick="submitEdit()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
  </div>
</div>

<script>
/* ================= SYSTEM CORE V6.3 ================= */
let DB = { version: "6.3", users: [], accounts: [], entries: [] };
let currentUser = null;
let currentMode = null;
let editingEntryId = null; 
let currentBusinessFilter = 'ALL'; 
let currentAccountFilterId = null; 
let currentReportFilter = 'day'; 

// Module 9: è´¦æˆ·åˆ†ç»„å®šä¹‰
const GROUPS = { 
  cash_bank: "ç°é‡‘ä¸é“¶è¡Œ", 
  trade: "è´¸æ˜“ä¸šåŠ¡", 
  transport: "è¿è¾“ä¸šåŠ¡", 
  plantation: "ç§æ¤ä¸šåŠ¡", 
  other: "å…¶ä»–" 
};
const KINDS = { 
  market: "è¶…å¸‚", canteen: "é£Ÿå ‚", supplier: "ä¾›åº”å•†", partner: "åˆä½œå•†", 
  staff: "å‘˜å·¥", customer: "å®¢æˆ·ç¾¤", bank: "é“¶è¡Œ", cash: "ç°é‡‘" 
};
const ROLES = {
    admin: "ç³»ç»Ÿç®¡ç†å‘˜",
    accountant: "ä¼šè®¡",
    shareholder: "è‚¡ä¸œ",
    agent: "åŒºä»£ç†"
};

const PL_CATEGORIES = {
  'INC_SALE': 'ä¸»è¥ä¸šåŠ¡æ”¶å…¥', 'INC_OTHER': 'å…¶ä»–æ”¶å…¥/æ‚é¡¹',
  'EXP_COST': 'é‡‡è´­/æˆæœ¬', 'EXP_SALARY': 'è–ªèµ„/äººåŠ›æˆæœ¬',
  'EXP_RENT': 'ç§Ÿé‡‘/è¾¦å…¬è´¹ç”¨', 'EXP_TRAVEL': 'å·®æ—…è´¹',
  'EXP_UTILITY': 'æ°´ç”µç…¤ç½‘è´¹', 'EXP_MAINT': 'ç¶­ä¿®ä¿å…»è´¹',
  'EXP_TAX': 'ç¨è´¹', 'EXP_OTHER': 'å…¶ä»–æ”¯å‡º/æ‚é¡¹'
};

function init() {
  const saved = localStorage.getItem("AG_TRADE_DB_V5"); // æ²¿ç”¨ V5 å­˜å‚¨é”®
  if (saved) {
    try {
      DB = JSON.parse(saved);
      if (DB.version !== "6.3") convertOldData(DB);
      if(!DB.users || DB.users.length===0 || !DB.users.some(u => u.role === 'admin')) { 
        // V6.3 åˆå§‹ç®¡ç†å‘˜: å¦‚æœæ²¡æœ‰ç®¡ç†å‘˜ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç®¡ç†å‘˜
        DB.users = [{id:uuid(), name:"Ivy Thien", username:"IVY1019", password:"000000", role:"admin"}];
        saveDB(); 
      }
      showLogin();
    } catch(e) { showImportLayer(); }
  } else {
    // V6.3 åˆå§‹ç®¡ç†å‘˜: ç³»ç»Ÿé¦–æ¬¡å¯åŠ¨åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜
    DB.users = [{id:uuid(), name:"Ivy Thien", username:"IVY1019", password:"000000", role:"admin"}];
    saveDB(); 
    showLogin();
  }
}

function convertOldData(db) {
  // V6.2: Ensure roles are set for legacy users and correct structure
  db.users.forEach(u => {
    if (!u.role) u.role = u.username === 'admin' ? 'admin' : 'shareholder';
  });

  db.accounts.forEach(acc => {
    if (!acc.group) {
      if (acc.kind === 'bank' || acc.kind === 'cash') acc.group = 'cash_bank';
      else if (['supplier', 'customer', 'partner', 'staff'].includes(acc.kind)) acc.group = 'trade'; 
      else acc.group = 'other';
    }
  });
  db.entries.forEach(e => {
    if (!e.plCategory) e.plCategory = '';
    if (!e.editedAt) e.editedAt = '';
    e.income = parseFloat((e.income || 0).toFixed(2));
    e.expense = parseFloat((e.expense || 0).toFixed(2));
  });
  db.version = "6.3";
  saveDB(); // Save converted data
}

function saveDB() { localStorage.setItem("AG_TRADE_DB_V5", JSON.stringify(DB)); }
function uuid() { return 'id'+Date.now()+Math.floor(Math.random()*1000); }
function today() { return new Date().toISOString().split('T')[0]; }
function formatDateTime(isoString) {
    if (!isoString) return 'æ— ';
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}
function formatAmount(num) {
    return (num || 0).toFixed(2);
}

/* ================= LOGIN & UI & PERMISSIONS (FIXED FOR CASE/SPACE) ================= */
function showImportLayer() { 
  document.getElementById('layer-import').classList.remove('hidden'); 
  document.getElementById('layer-login').classList.add('hidden');
}
function triggerImport() { document.getElementById('file-import').click(); }
function triggerImportBtn() { document.getElementById('file-import-btn').click(); }
function handleFileImport(input) {
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const json = JSON.parse(e.target.result);
      DB.users = json.users || [];
      DB.accounts = json.accounts || [];
      DB.entries = json.entries || [];
      convertOldData(DB);
      saveDB(); alert("å¯¼å…¥æˆåŠŸ"); location.reload();
    } catch(e) { alert("æ–‡ä»¶æ— æ•ˆ"); }
  };
  reader.readAsText(file);
}

function showLogin() {
  document.getElementById('layer-import').classList.add('hidden');
  document.getElementById('layer-login').classList.remove('hidden');
  document.getElementById('login-user-input').value = ""; 
  document.getElementById('login-pass').value = "";
  document.getElementById('login-user-input').focus();
}

/**
 * ä¿®æ­£åçš„ç™»å½•å‡½æ•° (FIXED)
 * 1. å¯¹è¾“å…¥è¿›è¡Œ trim() å»é™¤ç©ºæ ¼ã€‚
 * 2. å¯¹ç”¨æˆ·åè¿›è¡Œ toLowerCase() å®ç°å¤§å°å†™ä¸æ•æ„ŸåŒ¹é…ã€‚
 */
function doLogin() {
  // ä¼˜åŒ– 1: å¯¹ç”¨æˆ·åå’Œå¯†ç è¾“å…¥è¿›è¡Œå»ç©ºæ ¼ (trim()) å¤„ç†
  const uNameInput = document.getElementById('login-user-input').value.trim();
  const passInput = document.getElementById('login-pass').value.trim();
  
  // ä¼˜åŒ– 2: ç™»å½•åŒ¹é…æ—¶ï¼Œç”¨æˆ·åè¿›è¡Œå¤§å°å†™ä¸æ•æ„Ÿ (toLowerCase()) åŒ¹é…ï¼Œå¯†ç ä¿æŒç²¾ç¡®åŒ¹é…
  const u = DB.users.find(x => x.username.toLowerCase() === uNameInput.toLowerCase() && x.password === passInput);
  
  if(u) {
    currentUser = u;
    document.getElementById('display-user').textContent = `${u.name} (${ROLES[u.role] || u.role})`;
    document.getElementById('layer-login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    renderApp();
    updateUIPermissions(); // V6.2: Set permissions after login
  } else document.getElementById('login-msg').textContent = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯";
}

function doLogout() { currentUser=null; location.reload(); }
function systemReset() { 
  if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é‡ç½®ç³»ç»Ÿã€‚');
  if(!confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦å½»åº•é‡ç½®ç³»ç»Ÿå—ï¼Ÿæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼")) return;
  localStorage.removeItem("AG_TRADE_DB_V5");
  location.reload();
}

function renderApp() {
  renderAccounts();
  renderLedger();
  renderReport(currentReportFilter);
}

function updateUIPermissions() {
    const isEditor = currentUser.role === 'admin' || currentUser.role === 'accountant';
    const isAdmin = currentUser.role === 'admin';

    // éšè—/æ˜¾ç¤ºå¿«é€Ÿæ“ä½œåŒºåŸŸ (åªè¯»ç”¨æˆ·éšè—)
    document.querySelector('.action-bar').parentElement.style.display = isEditor ? 'block' : 'none';

    // éšè—/æ˜¾ç¤ºç³»ç»Ÿç®¡ç†æŒ‰é’® (Adminæƒé™)
    const adminBtns = document.querySelectorAll('.top-bar > div:last-child button'); 
    adminBtns.forEach(btn => {
        if(btn.textContent.includes('ç³»ç»Ÿé‡ç½®') || 
           btn.textContent.includes('å¯¼å…¥') || 
           btn.textContent.includes('å¯¼å‡º JSON')) {
             btn.style.display = isAdmin ? 'inline-block' : 'none';
        } else if (btn.textContent.includes('ç®¡ç†äººå‘˜')) {
             btn.style.display = isAdmin ? 'inline-block' : 'none';
        }
    });

    // åˆ é™¤å…¨éƒ¨è®°å½•æŒ‰é’® (Adminæƒé™)
    document.querySelector('button[onclick="deleteAllRecords()"]').style.display = isAdmin ? 'inline-block' : 'none';
}


/* ================= Module 7: ä¸šåŠ¡ç­›é€‰æ§åˆ¶ ================= */
function getGroupDisplayName(groupKey) {
    if (groupKey === 'ALL') return 'å…¨éƒ¨ä¸šåŠ¡';
    return GROUPS[groupKey] || '';
}

function setBusinessFilter(groupKey) {
    currentBusinessFilter = groupKey;
    
    document.querySelectorAll('.business-switcher button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.id === `filter-${groupKey.toUpperCase()}`) {
            btn.classList.add('active');
        }
    });

    renderApp();
}

function getAccountIdsInFilter() {
    if (currentBusinessFilter === 'ALL') {
        return DB.accounts.map(a => a.id);
    }
    const groupsToInclude = [currentBusinessFilter, 'cash_bank', 'other'];
    return DB.accounts
        .filter(a => groupsToInclude.includes(a.group))
        .map(a => a.id);
}

/* ================= è´¦æˆ·åˆ—è¡¨ (Click Filter & Drag) ================= */
let dragSrcEl = null;

function renderAccounts() {
  convertOldData(DB);
  const container = document.getElementById('acc-list-container');
  container.innerHTML = '';
  const groupedAccounts = {};
  Object.keys(GROUPS).forEach(k => groupedAccounts[k] = []);
  
  DB.accounts.forEach(acc => {
    const groupKey = acc.group; 
    
    if (currentBusinessFilter === 'ALL' || acc.group === currentBusinessFilter || acc.group === 'cash_bank') {
      if (!groupedAccounts[groupKey]) groupedAccounts[groupKey] = [];
      groupedAccounts[groupKey].push(acc);
    }
  });

  Object.keys(GROUPS).forEach(groupKey => {
    const list = groupedAccounts[groupKey];
    if (!list || list.length === 0) return;
    
    const div = document.createElement('div');
    div.className = 'acc-group';
    div.dataset.group = groupKey; 
    div.innerHTML = `<h4>${GROUPS[groupKey] || groupKey} (${list.length})</h4>`;
    
    list.forEach(acc => {
      const item = document.createElement('div');
      item.className = 'acc-item';
      if (acc.id === currentAccountFilterId) item.classList.add('selected'); 
      item.draggable = true;
      item.dataset.id = acc.id;
      item.dataset.group = acc.group; 
      item.onclick = () => toggleAccountFilter(acc.id); 
      item.innerHTML = `
        <span style="font-size:12px;">${acc.name}</span>
        <span class="acc-bal ${acc.balance<0?'neg':''}">${formatAmount(acc.balance)}</span>
      `;
      addDragEvents(item);
      div.appendChild(item);
    });
    container.appendChild(div);
  });
}

function toggleAccountFilter(accId) {
    if (currentAccountFilterId === accId) {
        currentAccountFilterId = null; 
    } else {
        currentAccountFilterId = accId;
    }
    renderAccounts(); 
    renderLedger(); 
}

function addDragEvents(item) {
  item.addEventListener('dragstart', function(e) { 
    if (currentUser.role !== 'admin') { e.preventDefault(); return; } // Only Admin can drag
    dragSrcEl = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; 
  });
  item.addEventListener('dragend', function(e) { this.classList.remove('dragging'); document.querySelectorAll('.acc-item').forEach(el => el.classList.remove('drag-over')); });
  item.addEventListener('dragover', function(e) { 
    e.preventDefault(); 
    if(dragSrcEl !== this && dragSrcEl.dataset.group === this.dataset.group && currentUser.role === 'admin') { 
        this.classList.add('drag-over'); 
    }
    return false; 
  });
  item.addEventListener('drop', function(e) {
    e.stopPropagation();
    if (dragSrcEl !== this && dragSrcEl.dataset.group === this.dataset.group && currentUser.role === 'admin') { 
      const srcId = dragSrcEl.dataset.id;
      const targetId = this.dataset.id;
      
      const srcIdxInFull = DB.accounts.findIndex(a => a.id === srcId);
      const targetIdxInFull = DB.accounts.findIndex(a => a.id === targetId);

      if(srcIdxInFull > -1 && targetIdxInFull > -1) {
          const [movedItem] = DB.accounts.splice(srcIdxInFull, 1);
          DB.accounts.splice(targetIdxInFull, 0, movedItem);
          saveDB(); renderAccounts();
      }
    }
    return false;
  });
}

/* ================= è´¦ç›®æ˜ç»† (V6.3 Optimization 1: Tooltip) ================= */
function getAccName(id) {
  const acc = DB.accounts.find(a => a.id === id);
  return acc ? acc.name : (id ? 'æœªçŸ¥è´¦æˆ·' : '-');
}

// V6.3 Optimization 1: Helper to create the tooltip string for account balance
function getAccTooltip(id) {
  const acc = DB.accounts.find(a => a.id === id);
  if (!acc || !acc.balance) return '';
  
  const balanceText = `å½“å‰ä½™é¢: ${formatAmount(acc.balance)}`;
  const accTypeText = `è´¦æˆ·ç±»å‹: ${KINDS[acc.kind] || 'N/A'}`;
  
  return `title="${balanceText} | ${accTypeText}" style="cursor: pointer; text-decoration: underline dotted; color: ${acc.balance < 0 ? 'var(--danger)' : 'var(--success)'};"`;
}

function renderLedger() {
  const tbody = document.querySelector('#ledger-table tbody');
  tbody.innerHTML = '';
  const search = document.getElementById('search-input').value.toLowerCase();
  const startDate = document.getElementById('filter-start-date').value;
  const endDate = document.getElementById('filter-end-date').value;
  
  const businessAccountIds = getAccountIdsInFilter(); 
  const isEditor = currentUser.role === 'admin' || currentUser.role === 'accountant';
  
  let filteredEntries = DB.entries.filter(e => {
    
    // ä¸šåŠ¡ç­›é€‰ 
    if (currentBusinessFilter !== 'ALL') {
        const isMainInGroup = businessAccountIds.includes(e.mainId);
        const isOtherInGroup = businessAccountIds.includes(e.otherId);
        if (!isMainInGroup && !isOtherInGroup) return false; 
    }
    
    // è´¦æˆ·ç‚¹å‡»ç­›é€‰ 
    if (currentAccountFilterId && e.mainId !== currentAccountFilterId && e.otherId !== currentAccountFilterId) {
        return false;
    }
    
    // æ—¥æœŸç­›é€‰ 
    if (startDate && e.date < startDate) return false;
    if (endDate && e.date > endDate) return false;

    // æœç´¢ç­›é€‰ 
    if(search) {
      const mainName = getAccName(e.mainId).toLowerCase();
      const otherName = getAccName(e.otherId).toLowerCase();
      if (!e.desc.toLowerCase().includes(search) && 
          !mainName.includes(search) && 
          !otherName.includes(search)) return false;
    }
    
    return true;
  });

  // æ’åº (æœ€æ–°æ—¥æœŸåœ¨æœ€ä¸Šé¢)
  filteredEntries.sort((a, b) => {
    if (a.date < b.date) return 1;
    if (a.date > b.date) return -1;
    if (a.id < b.id) return 1; 
    if (a.id > b.id) return -1;
    return 0;
  });
  
  filteredEntries.forEach(e => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.type}</td>
      <td>${e.desc || '-'}</td>
      <td ${getAccTooltip(e.mainId)}>${getAccName(e.mainId)}</td> 
      <td>${getAccName(e.otherId)}</td>
      <td style="color:${e.income>0?'var(--success)':'#ccc'}">${formatAmount(e.income)}</td>
      <td style="color:${e.expense>0?'var(--danger)':'#ccc'}">${formatAmount(e.expense)}</td>
      <td>${e.operator}</td>
      <td>
        ${isEditor ? `<button class="secondary sm" onclick="showEditModal('${e.id}')">ç¼–è¾‘</button>` : '---'}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function clearAllFilters() {
    currentAccountFilterId = null;
    document.getElementById('search-input').value = '';
    document.getElementById('filter-start-date').value = '';
    document.getElementById('filter-end-date').value = '';
    renderAccounts(); 
    renderLedger();
}

function deleteAllRecords() {
    if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ é™¤å…¨éƒ¨è®°å½•ã€‚');
    if (!confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦åˆ é™¤å½“å‰æ‰€æœ‰è´¦ç›®è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;
    DB.entries.forEach(e => reverseTransactionEffect(e)); 
    DB.entries = [];
    saveDB();
    renderApp();
}


/* ================= Module 8: ä¸“ä¸šç¼–è¾‘ç³»ç»Ÿ (Editor Only) ================= */
function showEditModal(entryId) {
  if (currentUser.role !== 'admin' && currentUser.role !== 'accountant') {
      return alert('æ‚¨çš„è§’è‰²æ— æƒè¿›è¡Œäº¤æ˜“ä¿®æ”¹æ“ä½œã€‚');
  }
  const entry = DB.entries.find(e => e.id === entryId);
  if (!entry) return alert('è®°å½•ä¸å­˜åœ¨');
  editingEntryId = entryId;

  document.getElementById('edit-entry-id').textContent = entryId;
  document.getElementById('edit-date').value = entry.date;
  document.getElementById('edit-desc').value = entry.desc || '';
  document.getElementById('edit-income').value = formatAmount(entry.income);
  document.getElementById('edit-expense').value = formatAmount(entry.expense);
  
  document.getElementById('edit-original-operator').textContent = entry.operator;
  document.getElementById('edit-last-edit').textContent = formatDateTime(entry.editedAt);
  
  fillSelect('edit-type', ['æ”¶å…¥','æ”¯å‡º','åº”æ”¶å¢åŠ ','æ”¶åº”æ”¶','åº”ä»˜å¢åŠ ','æ”¯ä»˜åº”ä»˜','è½¬è´¦','æœŸåˆ'], entry.type);
  fillSelect('edit-plCategory', Object.keys(PL_CATEGORIES), entry.plCategory, PL_CATEGORIES);
  fillAccountSelect('edit-mainId', entry.mainId);
  fillAccountSelect('edit-otherId', entry.otherId);

  document.getElementById('btn-delete-entry').onclick = () => { deleteEntry(entryId); document.getElementById('modal-edit').classList.add('hidden'); };

  document.getElementById('modal-edit').classList.remove('hidden');
}

function fillSelect(id, values, selectedValue, map = null) {
  const select = document.getElementById(id);
  select.innerHTML = '';
  select.add(new Option('---', ''));

  values.forEach(val => {
    const text = map ? map[val] : val;
    const option = new Option(text, val);
    if (val === selectedValue) option.selected = true;
    select.add(option);
  });
}

function fillAccountSelect(id, selectedAccId) {
  const select = document.getElementById(id);
  select.innerHTML = '';
  select.add(new Option('---', ''));
  DB.accounts.forEach(acc => {
    const option = new Option(acc.name, acc.id);
    if (acc.id === selectedAccId) option.selected = true;
    select.add(option);
  });
}

function submitEdit() {
  const id = editingEntryId;
  const entry = DB.entries.find(e => e.id === id);
  if (!entry) return;

  const newEntry = {
    date: document.getElementById('edit-date').value,
    type: document.getElementById('edit-type').value,
    plCategory: document.getElementById('edit-plCategory').value,
    desc: document.getElementById('edit-desc').value,
    mainId: document.getElementById('edit-mainId').value,
    otherId: document.getElementById('edit-otherId').value,
    income: parseFloat(parseFloat(document.getElementById('edit-income').value) || 0),
    expense: parseFloat(parseFloat(document.getElementById('edit-expense').value) || 0)
  };
  
  if (!newEntry.date || !newEntry.type || !newEntry.mainId || (newEntry.income===0 && newEntry.expense===0)) {
     return alert("è¯·ç¡®ä¿æ—¥æœŸã€ç±»å‹ã€ä¸»è´¦æˆ·ã€æ”¶å…¥æˆ–æ”¯å‡ºé‡‘é¢å·²å¡«å†™ï¼");
  }
  if (newEntry.type !== 'è½¬è´¦' && newEntry.type !== 'æœŸåˆ' && !newEntry.plCategory) {
     return alert("éè½¬è´¦/æœŸåˆäº¤æ˜“ï¼Œè¯·é€‰æ‹©æŸç›Šç±»åˆ«ï¼");
  }

  reverseTransactionEffect(entry); 

  Object.assign(entry, newEntry);
  
  entry.operator = `${currentUser.username} (ç¼–è¾‘)`; 
  entry.editedAt = new Date().toISOString(); 

  applyTransactionEffect(entry);

  saveDB(); 
  document.getElementById('modal-edit').classList.add('hidden');
  renderApp();
}


function updateBalance(id, delta) {
  if(!id) return;
  const acc = DB.accounts.find(a => a.id === id);
  if (acc) acc.balance = parseFloat(formatAmount(acc.balance + delta));
}

function applyTransactionEffect(e) {
  const main = e.mainId; const other = e.otherId;
  const inc = e.income || 0; const exp = e.expense || 0;
  if (e.type === "æ”¶å…¥") updateBalance(main, inc);
  else if (e.type === "æ”¯å‡º") updateBalance(main, -exp);
  else if (e.type === "åº”æ”¶å¢åŠ ") updateBalance(main, inc);
  else if (e.type === "æ”¶åº”æ”¶") { updateBalance(main, -inc); updateBalance(other, inc); }
  else if (e.type === "åº”ä»˜å¢åŠ ") updateBalance(main, -exp);
  else if (e.type === "æ”¯ä»˜åº”ä»˜") { updateBalance(main, exp); updateBalance(other, -exp); }
  else if (e.type === "è½¬è´¦") { updateBalance(main, -exp); updateBalance(other, exp); }
  else if (e.type === "æœŸåˆ") { updateBalance(main, (inc - exp)); }
  if (e.type === "è½¬è´¦" && inc > 0 && exp === 0) { updateBalance(main, -inc); updateBalance(other, inc); }
}

function reverseTransactionEffect(e) {
  const main = e.mainId; const other = e.otherId;
  const inc = e.income || 0; const exp = e.expense || 0;
  if (e.type === "æ”¶å…¥") updateBalance(main, -inc);
  else if (e.type === "æ”¯å‡º") updateBalance(main, exp);
  else if (e.type === "åº”æ”¶å¢åŠ ") updateBalance(main, -inc);
  else if (e.type === "æ”¶åº”æ”¶") { updateBalance(main, inc); updateBalance(other, -inc); }
  else if (e.type === "åº”ä»˜å¢åŠ ") updateBalance(main, exp);
  else if (e.type === "æ”¯ä»˜åº”ä»˜") { updateBalance(main, -exp); updateBalance(other, exp); }
  else if (e.type === "è½¬è´¦") { updateBalance(main, exp); updateBalance(other, -exp); }
  else if (e.type === "æœŸåˆ") { updateBalance(main, -(inc - exp)); }
  if (e.type === "è½¬è´¦" && inc > 0 && exp === 0) { updateBalance(main, inc); updateBalance(other, -inc); }
}

function deleteEntry(id) {
  if (currentUser.role !== 'admin' && currentUser.role !== 'accountant') {
      return alert('æ‚¨çš„è§’è‰²æ— æƒè¿›è¡Œäº¤æ˜“åˆ é™¤æ“ä½œã€‚');
  }
  if(!confirm(`âš ï¸ è­¦å‘Šï¼šåˆ é™¤è®°å½• (${id}) å°†å›æ»šä½™é¢ï¼Œç¡®å®šå½»åº•åˆ é™¤å—ï¼Ÿ`)) return; 
  const idx = DB.entries.findIndex(e => e.id === id);
  if(idx > -1) {
    reverseTransactionEffect(DB.entries[idx]);
    DB.entries.splice(idx, 1);
    saveDB(); renderApp();
  }
}

/* ================= TRANSACTION LOGIC (Editor Only) ================= */
function setMode(mode) {
  if (currentUser.role !== 'admin' && currentUser.role !== 'accountant') {
      return alert('æ‚¨çš„è§’è‰²æ— æƒè¿›è¡Œäº¤æ˜“å½•å…¥æ“ä½œã€‚');
  }
  
  currentMode = mode;
  const container = document.getElementById('form-inputs');
  const btn = document.getElementById('btn-submit');
  const title = document.getElementById('form-title');
  container.innerHTML = '';
  btn.classList.remove('hidden');

  const createSelect = (id, label, filterKind) => {
    let opts = '';
    DB.accounts.forEach(acc => {
      if (!filterKind || filterKind.includes(acc.kind)) 
        opts += `<option value="${acc.id}">${acc.name}</option>`;
    });
    return `<div class="col"><label>${label}</label><select id="${id}">${opts}</select></div>`;
  };
  
  // V6.3 Optimization 3: Enforce min="0" and step="0.01" for amounts
  const createInput = (id, label, type="text") => {
      let inputHtml = `<input id="${id}" type="${type}">`;
      if (type === 'number') {
          inputHtml = `<input id="${id}" type="${type}" min="0" step="0.01" value="">`;
      }
      return `<div class="col"><label>${label}</label>${inputHtml}</div>`;
  };
  
  let html = createInput('tx-date', 'æ—¥æœŸ', 'date');

  if(mode === 'IN') { title.innerText="ğŸ’° æ”¶å…¥"; html += createSelect('tx-acc', 'è´¦æˆ·',['bank','cash','customer']) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'OUT') { title.innerText="ğŸ’¸ æ”¯å‡º"; html += createSelect('tx-acc', 'è´¦æˆ·',['bank','cash']) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AR_ADD') { title.innerText="ğŸ“ åº”æ”¶æŒ‚è´¦"; html += createSelect('tx-acc', 'æ¬ æ¬¾äºº',['customer','supplier','partner']) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AR_GET') { title.innerText="âœ… æ”¶å›åº”æ”¶"; html += createSelect('tx-acc', 'è¿˜æ¬¾äºº',['customer','supplier','partner']) + createSelect('tx-to','æ”¶æ¬¾è´¦æˆ·',['bank','cash']) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AP_ADD') { title.innerText="ğŸ“ åº”ä»˜èµŠè´¦"; html += createSelect('tx-acc', 'å€ºæƒäºº',['supplier','partner','staff']) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AP_PAY') { title.innerText="ğŸ§§ æ”¯ä»˜åº”ä»˜"; html += createSelect('tx-acc', 'æ”¶æ¬¾äºº',['supplier','partner','staff']) + createSelect('tx-to','ä»˜æ¬¾è´¦æˆ·',['bank','cash']) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'TRANSFER') { title.innerText="ğŸ”„ è½¬è´¦"; html += createSelect('tx-from', 'è½¬å‡º') + createSelect('tx-to', 'è½¬å…¥') + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'OPEN_ACC') { 
    title.innerText="â• å¼€æˆ·"; 
    
    let groupOpts = '';
    Object.entries(GROUPS).forEach(([key, name]) => { groupOpts += `<option value="${key}">${name}</option>`; });
    let kindOpts = '';
    Object.entries(KINDS).forEach(([key, name]) => { kindOpts += `<option value="${key}">${name}</option>`; });

    html = `<div class="col"><label>åˆ†ç»„</label><select id="new-group">${groupOpts}</select></div>` 
    + `<div class="col"><label>ç±»å‹</label><select id="new-kind">${kindOpts}</select></div>` 
    + createInput('new-name','åç§°') 
    + createInput('new-bal','åˆå§‹ä½™é¢','number'); 
    
  }
  
  if(mode !== 'OPEN_ACC' && mode !== 'TRANSFER') {
    let plOpts = '<option value="">-- é€‰æ‹©æŸç›Šç±»åˆ«ï¼ˆå¿…é€‰ï¼‰ --</option>';
    const filter = (mode === 'IN' || mode === 'AR_ADD' || mode === 'AR_GET') ? 'INC_' : 'EXP_'; 
    Object.entries(PL_CATEGORIES).forEach(([key, name]) => {
      if(key.startsWith(filter)) plOpts += `<option value="${key}">${name}</option>`;
    });

    html += `<div class="col" style="flex:1 1 100%;"><label>æŸç›Šç±»åˆ«</label><select id="tx-pl-category">${plOpts}</select></div>`; 
    html += createInput('tx-desc', 'è¯´æ˜');
  } else if (mode === 'TRANSFER') {
      html += createInput('tx-desc', 'è¯´æ˜');
  }
  
  container.innerHTML = html;
  
  setTimeout(() => {
    if(document.getElementById('tx-date')) document.getElementById('tx-date').value = today();
    const focusEl = document.getElementById('tx-amt') || document.getElementById('new-name');
    if(focusEl) focusEl.focus();
  }, 50);
  
  container.onkeyup = (e) => { if(e.key === 'Enter') submitTransaction(); };
}

function submitTransaction() {
  const date = document.getElementById('tx-date') ? document.getElementById('tx-date').value : today();
  let entry = { 
    id: uuid(), date: date, operator: currentUser.username, 
    type:"", desc:"", mainId:"", otherId:"", income:0, expense:0,
    plCategory: "", editedAt: ""
  };

  if(currentMode === 'OPEN_ACC') {
    const name = document.getElementById('new-name').value;
    const kind = document.getElementById('new-kind').value;
    const group = document.getElementById('new-group').value;
    // Note: bal can be negative (e.g., overdraft), so no min="0" on this input
    const bal = parseFloat(parseFloat(document.getElementById('new-bal').value) || 0); 
    
    if(!name || !group || !kind) return alert("è¯·å¡«å†™å®Œæ•´çš„å¼€æˆ·ä¿¡æ¯");

    const newAcc = { id: uuid(), name, kind, group, balance: bal };
    DB.accounts.push(newAcc);
    
    if(bal !== 0) {
      entry.type="æœŸåˆ"; entry.desc="åˆå§‹ä½™é¢"; entry.mainId=newAcc.id; 
      if(bal>0) entry.income=bal; else entry.expense=Math.abs(bal);
      entry.plCategory = 'æœŸåˆä½™é¢';
      DB.entries.unshift(entry);
    }

  } else {
    // V6.3: min="0" on input handles non-positive values, but check for zero
    const amt = parseFloat(parseFloat(document.getElementById('tx-amt').value));
    const desc = document.getElementById('tx-desc').value;
    const plCategory = document.getElementById('tx-pl-category') ? document.getElementById('tx-pl-category').value : '';

    if(isNaN(amt) || amt<=0) return alert("é‡‘é¢é”™è¯¯æˆ–æœªå¡«å†™ã€‚é‡‘é¢å¿…é¡»å¤§äº0ã€‚");
    if(!plCategory && currentMode !== 'TRANSFER') return alert("è¯·é€‰æ‹©æŸç›Šç±»åˆ«");
    
    entry.desc = desc;
    entry.plCategory = plCategory;

    const main = document.getElementById('tx-acc') ? document.getElementById('tx-acc').value : document.getElementById('tx-from').value;
    const other = document.getElementById('tx-to') ? document.getElementById('tx-to').value : "";
    
    entry.mainId = main; entry.otherId = other;
    
    if(currentMode==='IN') { entry.type="æ”¶å…¥"; entry.income=amt; updateBalance(main, amt); }
    else if(currentMode==='OUT') { entry.type="æ”¯å‡º"; entry.expense=amt; updateBalance(main, -amt); }
    else if(currentMode==='AR_ADD') { entry.type="åº”æ”¶å¢åŠ "; entry.income=amt; updateBalance(main, amt); }
    else if(currentMode==='AR_GET') { entry.type="æ”¶åº”æ”¶"; entry.income=amt; updateBalance(main, -amt); updateBalance(other, amt); }
    else if(currentMode==='AP_ADD') { entry.type="åº”ä»˜å¢åŠ "; entry.expense=amt; updateBalance(main, -amt); }
    else if(currentMode==='AP_PAY') { entry.type="æ”¯ä»˜åº”ä»˜"; entry.expense=amt; updateBalance(main, amt); updateBalance(other, -amt); }
    else if(currentMode==='TRANSFER') { entry.type="è½¬è´¦"; entry.expense=amt; updateBalance(main, -amt); updateBalance(other, amt); }
    
    DB.entries.unshift(entry);
  }
  
  saveDB(); renderApp();

  if(document.getElementById('tx-amt')) document.getElementById('tx-amt').value = '';
  if(document.getElementById('tx-desc')) document.getElementById('tx-desc').value = '';
  if(document.getElementById('tx-pl-category')) document.getElementById('tx-pl-category').value = '';
  
  const focusEl = document.getElementById('tx-amt') || document.getElementById('new-name');
  if(focusEl) focusEl.focus();

  const btn = document.getElementById('btn-submit');
  btn.innerText = "å·²ä¿å­˜ âœ”";
  setTimeout(()=> btn.innerText="ç¡®è®¤æäº¤ (Enter)", 1000);
}

/* ================= REPORT & EXPORT ================= */
function renderReport(range) {
  currentReportFilter = range; 
  let startStr = "";
  let endStr = "";
  const now = new Date();
  
  // 1. æ—¥æœŸè®¡ç®—
  if(range==='day') {
    startStr = today();
    endStr = today();
  } else if(range==='month') {
    startStr = now.toISOString().slice(0,7) + '-01';
    endStr = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
  } else if(range==='week') {
    const d = new Date();
    const dayOfWeek = (d.getDay() + 6) % 7; // 0=Mon, 6=Sun
    d.setDate(d.getDate() - dayOfWeek);
    startStr = d.toISOString().split('T')[0];
    d.setDate(d.getDate() + 6);
    endStr = d.toISOString().split('T')[0];
  }

  // 2. ç»Ÿè®¡
  let tin=0, tout=0;
  DB.entries.forEach(e => {
    const validAccountIds = getAccountIdsInFilter();
    if (currentBusinessFilter !== 'ALL') {
        const isMainInGroup = validAccountIds.includes(e.mainId);
        const isOtherInGroup = validAccountIds.includes(e.otherId);
        if (!isMainInGroup && !isOtherInGroup) return;
    }

    if (e.date >= startStr && e.date <= endStr && e.type !== 'è½¬è´¦' && e.type !== 'æœŸåˆ' && !e.type.includes('å¢åŠ ')) {
        tin += (e.income||0); tout += (e.expense||0);
    }
  });

  // 3. æ¸²æŸ“
  document.getElementById('rpt-in').innerText = formatAmount(tin);
  document.getElementById('rpt-out').innerText = formatAmount(tout);
  document.getElementById('rpt-net').innerText = formatAmount(tin-tout);
  
  // 4. ç»‘å®šç‚¹å‡»äº‹ä»¶ 
  document.getElementById('card-in').onclick = () => filterLedgerByReport(range);
  document.getElementById('card-out').onclick = () => filterLedgerByReport(range);
  document.getElementById('card-net').onclick = () => filterLedgerByReport(range);

  // 5. çªå‡ºæ˜¾ç¤ºå½“å‰é€‰å®šçš„æ—¶é—´èŒƒå›´æŒ‰é’®
  document.querySelectorAll('.card > div:first-child > div:last-child button').forEach(btn => {
      btn.classList.remove('primary');
      btn.classList.add('secondary');
  });
  document.getElementById(`btn-rpt-${range}`).classList.remove('secondary');
  document.getElementById(`btn-rpt-${range}`).classList.add('primary');
}

function filterLedgerByReport(range) {
    let startStr = "";
    let endStr = "";
    const now = new Date();
    
    if(range==='day') {
        startStr = today();
        endStr = today();
    } else if(range==='month') {
        startStr = now.toISOString().slice(0,7) + '-01';
        endStr = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    } else if(range==='week') {
        const d = new Date();
        const dayOfWeek = (d.getDay() + 6) % 7; // 0=Mon, 6=Sun
        d.setDate(d.getDate() - dayOfWeek);
        startStr = d.toISOString().split('T')[0];
        d.setDate(d.getDate() + 6);
        endStr = d.toISOString().split('T')[0];
    }

    document.getElementById('filter-start-date').value = startStr;
    document.getElementById('filter-end-date').value = endStr;
    renderLedger();
}

function exportJSON() {
  if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥å¯¼å‡º JSONã€‚');
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `AG_Backup_${today()}.json`;
  a.click();
}

function exportCSV() {
  // All users can export CSV (read-only action)
    const header = ["æ—¥æœŸ", "ç±»å‹", "è¯´æ˜", "æŸç›Šç±»åˆ«", "ä¸»è´¦æˆ·", "å¯¹æ–¹è´¦æˆ·", "æ”¶å…¥", "æ”¯å‡º", "æ“ä½œäºº", "æœ€åç¼–è¾‘æ—¶é—´", "äº¤æ˜“ID"];
    
    const entriesData = DB.entries.map(e => ({
        ...e,
        mainAccName: getAccName(e.mainId),
        otherAccName: getAccName(e.otherId),
        plCategoryName: PL_CATEGORIES[e.plCategory] || e.plCategory || '-'
    }));

    const search = document.getElementById('search-input').value.toLowerCase();
    const startDate = document.getElementById('filter-start-date').value;
    const endDate = document.getElementById('filter-end-date').value;
    const businessAccountIds = getAccountIdsInFilter(); 

    const filteredForExport = entriesData.filter(e => {
        if (currentBusinessFilter !== 'ALL') {
            const isMainInGroup = businessAccountIds.includes(e.mainId);
            const isOtherInGroup = businessAccountIds.includes(e.otherId);
            if (!isMainInGroup && !isOtherInGroup) return false; 
        }
        
        if (currentAccountFilterId && e.mainId !== currentAccountFilterId && e.otherId !== currentAccountFilterId) return false;
        if (startDate && e.date < startDate) return false;
        if (endDate && e.date > endDate) return false;

        if(search) {
            const mainName = e.mainAccName.toLowerCase();
            const otherName = e.otherAccName.toLowerCase();
            if (!e.desc.toLowerCase().includes(search) && 
                !mainName.includes(search) && 
                !otherName.includes(search)) return false;
        }
        return true;
    });

    const csvData = filteredForExport.map(e => [
        e.date,
        e.type,
        e.desc || '',
        e.plCategoryName,
        e.mainAccName,
        e.otherAccName,
        formatAmount(e.income), 
        formatAmount(e.expense), 
        e.operator,
        formatDateTime(e.editedAt),
        e.id
    ]);

    const csv = Papa.unparse({ fields: header, data: csvData });
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); 
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `AG_Ledger_Export_${today()}.csv`;
    a.click();
}

function exportPDF() {
  // All users can export PDF (read-only action)
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const filteredForPDF = (() => {
    const search = document.getElementById('search-input').value.toLowerCase();
    const startDate = document.getElementById('filter-start-date').value;
    const endDate = document.getElementById('filter-end-date').value;
    const businessAccountIds = getAccountIdsInFilter(); 

    let entriesData = DB.entries.map(e => ({
        ...e,
        mainAccName: getAccName(e.mainId),
        otherAccName: getAccName(e.otherId),
        plCategoryName: PL_CATEGORIES[e.plCategory] || e.plCategory || '-'
    }));
    
    return entriesData.filter(e => {
        if (currentBusinessFilter !== 'ALL') {
            const isMainInGroup = businessAccountIds.includes(e.mainId);
            const isOtherInGroup = businessAccountIds.includes(e.otherId);
            if (!isMainInGroup && !isOtherInGroup) return false; 
        }
        
        if (currentAccountFilterId && e.mainId !== currentAccountFilterId && e.otherId !== currentAccountFilterId) return false;
        if (startDate && e.date < startDate) return false;
        if (endDate && e.date > endDate) return false;

        if(search) {
            const mainName = e.mainAccName.toLowerCase();
            const otherName = e.otherAccName.toLowerCase();
            if (!e.desc.toLowerCase().includes(search) && 
                !mainName.includes(search) && 
                !otherName.includes(search)) return false;
        }
        return true;
    }).sort((a, b) => a.date < b.date ? 1 : -1);
  })();

  doc.text("AG è´¦ç›®æ˜ç»†æŠ¥å‘Š (å½“å‰ç­›é€‰)", 10, 10);
  doc.text(`ä¸šåŠ¡: ${getGroupDisplayName(currentBusinessFilter) || 'å…¨éƒ¨'} | è´¦æˆ·: ${getAccName(currentAccountFilterId) || 'å…¨éƒ¨'} | æ—¥æœŸ: ${document.getElementById('filter-start-date').value || 'èµ·å§‹'} - ${document.getElementById('filter-end-date').value || 'ç»“æŸ'}`, 10, 17);
  
  let y = 30;
  const lineHeight = 7;
  doc.setFontSize(9);
  
  filteredForPDF.forEach(e => {
    const line1 = `æ—¥æœŸ: ${e.date} | ç±»å‹: ${e.type} | æŸç›Šç±»åˆ«: ${e.plCategoryName}`; 
    const line2 = `è´¦æˆ·: ${e.mainAccName} -> ${e.otherAccName || '-'} | æ”¶: ${formatAmount(e.income)} / æ”¯: ${formatAmount(e.expense)}`;
    const line3 = `è¯´æ˜: ${e.desc || '-'} | æ“ä½œ: ${e.operator}`;
    
    if (y > 280) { doc.addPage(); y = 10; }
    doc.text(line1, 10, y); y += lineHeight;
    if (y > 280) { doc.addPage(); y = 10; }
    doc.text(line2, 10, y); y += lineHeight;
    if (y > 280) { doc.addPage(); y = 10; }
    doc.text(line3, 10, y); y += lineHeight + 1; 
  });
  doc.save(`AG_Ledger_Report_${today()}.pdf`);
}

/* ================= MANAGER (Admin Only) (FIXED FOR CASE/SPACE) ================= */
function showManager() { 
  if (currentUser.role !== 'admin') {
      return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†ï¼');
  }
  document.getElementById('modal-mgr').classList.remove('hidden'); 
  renderUsers(); 
}

function renderUsers() {
    const tbody = document.querySelector('#user-table tbody'); tbody.innerHTML='';
    DB.users.forEach(u => {
        const isSelf = u.id === currentUser.id;
        
        // Admin å¯ä»¥ç¼–è¾‘æ‰€æœ‰äººçš„å§“å
        const nameInput = `<input type="text" value="${u.name}" onchange="updateUser('${u.id}', 'name', this.value)">`;
        
        // å¯†ç è¾“å…¥æ¡†ç”¨äºè®¾ç½®æ–°å¯†ç ï¼Œä¸æ˜¾ç¤ºæ—§å¯†ç ã€‚å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œåˆ™ä¸ä¿®æ”¹ã€‚
        const passInput = `<input type="password" id="user-pass-${u.id}" placeholder="****** (è¾“å…¥ä»¥ä¿®æ”¹)" onchange="updateUser('${u.id}', 'password', this.value)">`;

        const canDelete = !isSelf; // Admin å¯ä»¥åˆ é™¤æ‰€æœ‰äººï¼Œé™¤äº†è‡ªå·±
        
        tbody.innerHTML += `<tr>
            <td>${nameInput}</td>
            <td>${u.username} (${ROLES[u.role] || u.role})</td>
            <td>${passInput}</td>
            <td>
              ${canDelete ? `<button class="danger sm" onclick="delUser('${u.id}')">åˆ é™¤</button>` : '---'}
            </td>
          </tr>`;
    });
}

function updateUser(id, field, value) {
    const user = DB.users.find(u => u.id === id);
    if (!user) return;
    
    const trimmedValue = value.trim(); // ä¼˜åŒ– 3: å¯¹è¾“å…¥å€¼å»ç©ºæ ¼
    
    if(field === 'password') {
        if (trimmedValue === '') return; // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œåˆ™ä¸ä¿®æ”¹
        if (trimmedValue.length < 6) { // V6.3 Optimization 2 validation
            alert("å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä½å­—ç¬¦ï¼");
            renderUsers(); // é‡æ–°æ¸²æŸ“ä»¥æ¸…é™¤æ— æ•ˆè¾“å…¥
            return;
        }
        user[field] = trimmedValue; // ä½¿ç”¨å»é™¤ç©ºæ ¼çš„å¯†ç 
    } else {
        user[field] = trimmedValue;
    }
    
    saveDB();
    if (currentUser.id === id) {
        if (field === 'name') document.getElementById('display-user').textContent = `${trimmedValue} (${ROLES[user.role] || user.role})`;
        if (field === 'role') document.getElementById('display-user').textContent = `${user.name} (${ROLES[user.role] || user.role})`;
    }
}

/**
 * ä¿®æ­£åçš„æ·»åŠ ç”¨æˆ·å‡½æ•° (FIXED)
 * 1. å¯¹è¾“å…¥è¿›è¡Œ trim() å»é™¤ç©ºæ ¼ã€‚
 * 2. å¯¹ç”¨æˆ·åè¿›è¡Œ toLowerCase() å®ç°å¤§å°å†™ä¸æ•æ„Ÿçš„å”¯ä¸€æ€§æ£€æŸ¥ã€‚
 */
function addUser() {
  // ä¼˜åŒ– 1: å½•å…¥å‰å¯¹è¾“å…¥å€¼è¿›è¡Œå»ç©ºæ ¼ (trim()) å¤„ç†
  const name=document.getElementById('new-u-name').value.trim();
  const user=document.getElementById('new-u-user').value.trim();
  const pass=document.getElementById('new-u-pass').value.trim();
  const role=document.getElementById('new-u-role').value;

  if(!name || !user || !pass || !role) return alert("è¯·å¡«å†™å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯");
  
  // ä¼˜åŒ– 2: ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥åº”å¿½ç•¥å¤§å°å†™
  if(DB.users.some(u => u.username.toLowerCase() === user.toLowerCase())) return alert("ç”¨æˆ·åå·²å­˜åœ¨ï¼");

  if(pass.length < 6) return alert("å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä½å­—ç¬¦ï¼"); // å¯†ç é•¿åº¦æ ¡éªŒ

  DB.users.push({id:uuid(), name, username:user, password:pass, role:role}); 
  saveDB(); 
  renderUsers(); 
  document.getElementById('new-u-name').value = document.getElementById('new-u-user').value = document.getElementById('new-u-pass').value = '';
}
function delUser(id) { 
  if(!confirm("ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ")) return;
  DB.users = DB.users.filter(u=>u.id!==id); 
  saveDB(); 
  renderUsers(); 
}

init();
</script>
</body>
</html>
