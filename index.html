<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°¸é‘«è´¸æ˜“åˆä½œç¤¾æœ‰é™å…¬å¸ - AG ç°é‡‘æµæŠ¥è¡¨ V6.7 (å¼€æˆ·ç±»å‹è”åŠ¨ä¿®æ­£ç‰ˆ)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  :root {
    --bg-color: #fef9c3;
    --card-bg: #ffffff;
    --primary: #f59e0b; /* æ©™è‰² */
    --gold: #d97706; /* æ·±é‡‘è‰²ç”¨äºå“ç‰Œå */
    --danger: #dc2626;
    --success: #0d9488;
    --text-main: #1f2937;
    --text-sub: #6b7280;
    --border: #e5e7eb;
  }

  body {
    margin: 0; padding: 0;
    background-color: var(--bg-color);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color: var(--text-main);
    font-size: 14px;
  }

  .hidden { display: none !important; }
  .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
  
  .card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  h2, h3, h4 { margin: 0 0 10px 0; font-weight: 600; }
  h3 { font-size: 16px; color: var(--text-main); border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; margin-bottom: 15px;}
  
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;}
  .col { flex: 1; min-width: 150px; }
  
  label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
  input, select {
    width: 100%; box-sizing: border-box;
    padding: 8px; border: 1px solid var(--border);
    border-radius: 6px; font-size: 14px; outline: none;
  }
  input:focus, select:focus { border-color: var(--primary); }

  button {
    cursor: pointer; padding: 8px 16px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 500; transition: opacity 0.2s;
  }
  button:hover { opacity: 0.9; }
  button.primary { background: var(--primary); color: white; }
  button.danger { background: var(--danger); color: white; }
  button.teal { background: var(--success); color: white; }
  button.secondary { background: #e5e7eb; color: var(--text-main); }
  button.sm { padding: 4px 10px; font-size: 12px; }

  /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
  .acc-item {
    background: white; padding: 6px 8px; margin-bottom: 6px;
    border-radius: 4px; border: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .acc-item:hover { box-shadow: 0 0 0 2px var(--primary); } 
  .acc-item.selected { box-shadow: 0 0 0 3px var(--success); } 
  .acc-item.dragging { opacity: 0.5; background: #fef3c7; border: 1px dashed var(--primary); }
  .acc-item.drag-over { border-top: 2px solid var(--primary); }

  /* è´¦æˆ·ç®¡ç†æŒ‰é’® */
  .acc-controls { display: none; gap: 5px; margin-left: 10px; }
  .acc-item:hover .acc-controls { display: flex; }
  .btn-icon { cursor: pointer; padding: 2px 5px; border-radius: 4px; font-size: 12px; }
  .btn-icon.edit { background: #e5e7eb; color: #374151; }
  .btn-icon.del { background: #fee2e2; color: #dc2626; }

  /* è´¦æˆ·åˆ—è¡¨å¸ƒå±€ (Grouped) */
  .acc-scroll { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 0; }
  .acc-group {
    flex: 1; min-width: 180px;
    background: #f9fafb; border: 1px solid var(--border);
    border-radius: 8px; padding: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .acc-group h4 { font-size: 14px; color: var(--text-main); text-align: center; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 5px;}
  .acc-bal { font-weight: bold; font-family: monospace; font-size: 13px; }
  .acc-bal.neg { color: var(--danger); }

  /* è¡¨æ ¼æ ·å¼ & å›ºå®šè¡¨å¤´ */
  .table-responsive { overflow-y: auto; max-height: 500px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; } 
  th, td { text-align: left; padding: 6px 5px; border-bottom: 1px solid var(--border); } 
  th { 
    background: #f9fafb; font-weight: 600; color: var(--text-sub); 
    position: sticky; top: 0; z-index: 10; 
  }
  tr:hover { background: #fffbe6; }

  /* Overlay and Modal */
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(254, 249, 195, 0.9); z-index: 1000; 
    display: flex; align-items: center; justify-content: center;
  }
  .overlay-box {
    background: white; padding: 30px; border-radius: 16px;
    width: 90%; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: center;
  }
  .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center; z-index: 2000;
  }
  .modal-content {
    background: white; padding: 20px; border-radius: 12px;
    width: 90%; max-width: 700px; 
    max-height: 90vh; overflow-y: auto;
  }

  /* ä¸šåŠ¡åˆ‡æ¢æ  */
  .business-switcher {
    display: flex; gap: 5px; margin-bottom: 15px;
    background: #e5e7eb; padding: 5px; border-radius: 8px;
  }
  .business-switcher button {
    flex: 1; background: transparent; color: var(--text-main); padding: 6px 12px; font-weight: 500;
  }
  .business-switcher button.active {
    background: var(--primary); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  
  /* Dashboard Card Link */
  .dash-grid { display: flex; gap: 10px; flex-wrap: wrap; }
  .dash-card { flex: 1; background: #fffbe6; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #fde68a; cursor: pointer; transition: background 0.2s;}
  .dash-card:hover { background: #fef3c7; }
  .dash-val { font-size: 20px; font-weight: bold; color: var(--text-main); margin-top: 5px; }

</style>
</head>
<body>

<div id="layer-import" class="overlay">
  <div class="overlay-box">
    <h2 style="color:var(--gold); margin-bottom:5px;">æ°¸é‘«è´¸æ˜“åˆä½œç¤¾æœ‰é™å…¬å¸</h2>
    <h3 style="color:var(--gold); border-bottom:none; margin-bottom:20px;">AlwaysGold Sdn. Bhd.</h3>
    <p style="color:var(--text-sub); margin-bottom:20px;">è¯·å¯¼å…¥ JSON å¤‡ä»½å¯åŠ¨ç³»ç»Ÿ</p>
    <button class="primary" onclick="triggerImport()">ğŸ“‚ å¯¼å…¥ JSON å¤‡ä»½æ–‡ä»¶</button>
    <input type="file" id="file-import" accept=".json" class="hidden" onchange="handleFileImport(this)">
  </div>
</div>

<div id="layer-login" class="overlay hidden">
  <div class="overlay-box">
    <h2 style="color:var(--gold); margin-bottom:5px;">æ°¸é‘«è´¸æ˜“åˆä½œç¤¾æœ‰é™å…¬å¸</h2>
    <h3 style="color:var(--gold); border-bottom:none; margin-bottom:20px;">AlwaysGold Sdn. Bhd.</h3>
    <h4 style="margin-top:-10px;">ç”¨æˆ·ç™»å½•</h4>
    <div style="text-align:left; margin-top:15px;">
      <label>ç”¨æˆ·å</label>
      <input type="text" id="login-user-input">
      <div style="height:10px;"></div>
      <label>å¯†ç </label>
      <input type="password" id="login-pass" onkeyup="if(event.key==='Enter') doLogin()">
    </div>
    <button class="primary" style="width:100%; margin-top:20px;" onclick="doLogin()">ç™»å½•ç³»ç»Ÿ</button>
    <p id="login-msg" style="color:var(--danger); font-size:12px; margin-top:10px;"></p>
  </div>
</div>

<div id="app" class="container hidden">
  
  <div class="top-bar">
    <div>
      <h2 style="margin:0;">AG è´¸æ˜“ç°é‡‘æµæŠ¥è¡¨ â€” V6.7</h2>
      <span style="font-size:12px; color:#666;">
        å‰¯æ ‡é¢˜ï¼šæƒé™éš”ç¦» Â· æŠ¥è¡¨è”åŠ¨ Â· å®¡è®¡ç•™ç—• Â· æœ¬åœ°ä¿å­˜<br>
        æ“ä½œäºº: <b id="display-user"></b>
      </span>
    </div>
    <div style="display:flex; gap:5px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="secondary sm" onclick="showManager()">ğŸ‘¤ ç®¡ç†äººå‘˜</button>
      <button class="secondary sm" onclick="triggerImportBtn()">ğŸ“‚ å¯¼å…¥ JSON</button>
      <input type="file" id="file-import-btn" accept=".json" class="hidden" onchange="handleFileImport(this)">
      <button class="secondary sm" onclick="exportJSON()">ğŸ’¾ å¯¼å‡º JSON</button>
      <button class="secondary sm" onclick="exportCSV()">ğŸ“„ å¯¼å‡º CSV</button>
      <button class="secondary sm" onclick="exportPDF()">ğŸ“„ å¯¼å‡º PDF</button>
      <button class="danger sm" onclick="systemReset()">âš ï¸ ç³»ç»Ÿé‡ç½®</button>
      <button class="secondary sm" onclick="doLogout()">é€€å‡º</button>
    </div>
  </div>
  
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <h3>è´¢åŠ¡æ¦‚è§ˆ & æŠ¥è¡¨åˆ†æ (æŒ‰æ—¥æœŸç­›é€‰)</h3>
        
        <div style="display:flex; gap:5px; align-items:center; background:#f3f4f6; padding:5px; border-radius:8px;">
            <label style="margin:0;">èµ·å§‹æ—¥æœŸ</label>
            <input type="date" id="dash-start" style="width:130px;" onchange="renderApp()">
            <span style="color:#999; margin:0 5px;">è‡³</span>
            <label style="margin:0;">ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="dash-end" style="width:130px;" onchange="renderApp()">
            <button class="primary sm" style="height:34px;" onclick="renderApp()">ğŸ” æŸ¥è¯¢</button>
            
            <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
            <button class="secondary sm" id="btn-rpt-day" onclick="setDateRange('day')">ä»Šæ—¥</button>
            <button class="secondary sm" id="btn-rpt-week" onclick="setDateRange('week')">æœ¬å‘¨</button>
            <button class="secondary sm" id="btn-rpt-month" onclick="setDateRange('month')">æœ¬æœˆ</button>
        </div>
    </div>
    <div class="dash-grid" style="margin-top:15px;">
      <div class="dash-card" id="card-in"><div>æ”¶å…¥</div><div class="dash-val" id="rpt-in" style="color:var(--success)">0.00</div></div>
      <div class="dash-card" id="card-out"><div>æ”¯å‡º</div><div class="dash-val" id="rpt-out" style="color:var(--danger)">0.00</div></div>
      <div class="dash-card" id="card-net"><div>å‡€ç°é‡‘æµ</div><div class="dash-val" id="rpt-net">0.00</div></div>
    </div>
  </div>


  <div class="card" id="quick-action-card">
    <h3>å¿«é€Ÿæ“ä½œ</h3>
    <div class="action-bar">
      <button class="action-btn secondary" onclick="setMode('IN')">ğŸ’° æ”¶å…¥</button>
      <button class="action-btn secondary" onclick="setMode('OUT')">ğŸ’¸ æ”¯å‡º</button>
      <button class="action-btn secondary" onclick="setMode('AR_ADD')">ğŸ“ åº”æ”¶(æŒ‚è´¦)</button>
      <button class="action-btn teal" onclick="setMode('AR_GET')">âœ… æ”¶åº”æ”¶</button>
      <button class="action-btn secondary" onclick="setMode('AP_ADD')">ğŸ“ åº”ä»˜(èµŠè´¦)</button>
      <button class="action-btn danger" onclick="setMode('AP_PAY')">ğŸ§§ æ”¯ä»˜åº”ä»˜</button>
      <button class="action-btn secondary" onclick="setMode('TRANSFER')">ğŸ”„ è½¬è´¦</button>
      <button class="action-btn secondary" style="margin-left:auto;" onclick="setMode('OPEN_ACC')">â• å¼€æˆ·</button>
    </div>
    <div id="action-form" style="background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #e5e7eb;">
      <h4 id="form-title" style="color:var(--primary); margin-bottom:10px;">è¯·é€‰æ‹©æ“ä½œ...</h4>
      <div id="form-inputs" class="row"></div>
      <div style="margin-top:10px; text-align:right;">
        <button id="btn-submit" class="primary hidden" onclick="submitTransaction()">ç¡®è®¤æäº¤ (Enter)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>è´¦æˆ·åˆ—è¡¨ (æŒ‰ä¸šåŠ¡åˆ†ç»„)</h3>
    <p style="font-size:12px; color:#999; margin-top:-10px; margin-bottom:10px;">æç¤ºï¼šç‚¹å‡»è´¦æˆ·ç­›é€‰æ˜ç»†ï¼ŒæŒ‰ä½å¡ç‰‡å¯è¿›è¡Œæ‹–æ‹½æ’åºã€‚ç®¡ç†å‘˜å¯ç®¡ç†è´¦æˆ·ã€‚</p>
    <div class="acc-scroll" id="acc-list-container"></div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
      <h3>è´¦ç›®æ˜ç»† (å½“å‰æƒé™å¯è§èŒƒå›´)</h3> 
      <div class="row" style="flex:1; max-width:400px; margin-left:auto;">
          <div class="col" style="min-width:150px;"><label>æœç´¢</label><input type="text" id="search-input" placeholder="æœç´¢è¯´æ˜/è´¦æˆ·å..." onkeyup="renderLedger()"></div>
          <div class="col" style="min-width:150px; flex:0 0 auto; display:flex; gap:5px;">
              <button class="secondary sm" style="align-self:flex-end;" onclick="clearAllFilters()">æ¸…ç©º</button>
              <button class="danger sm" id="btn-delete-all" onclick="deleteAllRecords()">åˆ é™¤å…¨éƒ¨</button>
          </div>
      </div>
    </div>
    <div class="table-responsive">
      <table id="ledger-table">
        <thead>
          <tr>
            <th style="width:10%;">æ—¥æœŸ</th>
            <th style="width:8%;">ç±»å‹</th>
            <th style="width:25%;">è¯´æ˜</th>
            <th style="width:10%;">ä¸»è´¦æˆ·</th>
            <th style="width:10%;">å¯¹æ–¹è´¦æˆ·</th>
            <th style="width:9%; color:var(--success)">æ”¶å…¥</th>
            <th style="width:9%; color:var(--danger)">æ”¯å‡º</th>
            <th style="width:9%;">æ“ä½œäºº</th>
            <th style="width:10%;">ç®¡ç†</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal-mgr" class="modal hidden">
  <div class="modal-content" style="max-width:750px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>äººå‘˜æƒé™ç®¡ç† (ä»…é™ç®¡ç†å‘˜)</h3>
        <p style="font-size:11px; color:var(--danger); margin:0;">âš ï¸ å¯†ç å»ºè®®é•¿åº¦ â‰¥ 6 ä½</p>
        <button class="secondary sm" onclick="document.getElementById('modal-mgr').classList.add('hidden')">å…³é—­</button>
    </div>
    
    <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:15px; margin-top:10px;">
      <h4 style="margin-top:0;">æ·»åŠ æ–°ç”¨æˆ· / æƒé™è®¾ç½®</h4>
      <div class="row">
        <div class="col" style="min-width:120px;"><label>å§“å</label><input id="new-u-name" placeholder="å§“å"></div>
        <div class="col" style="min-width:120px;"><label>ç”¨æˆ·å</label><input id="new-u-user" placeholder="ç™»å½•ç”¨æˆ·å"></div>
        <div class="col" style="min-width:140px;"><label>è§’è‰²</label>
          <select id="new-u-role">
            <option value="admin">ç³»ç»Ÿç®¡ç†å‘˜ (å…¨æƒ)</option>
            <option value="accountant">ä¼šè®¡ (é™åˆ¶ä¿®æ”¹/æ— åˆ é™¤)</option>
            <option value="shareholder">è‚¡ä¸œ (åªè¯»æŒ‡å®šä¸šåŠ¡)</option>
            <option value="agent">åŒºä»£ç† (åªè¯»æŒ‡å®šåŒºåŸŸ)</option>
          </select>
        </div>
        <div class="col" style="min-width:120px;"><label>å¯†ç </label><input id="new-u-pass" type="password" placeholder="è®¾ç½®æ–°å¯†ç "></div>
      </div>
      
      <div class="row" style="margin-top:10px;">
         <div class="col"><label>å¤‡æ³¨è¯¦æƒ… (å¦‚: KCHåŒºEMART ä¼šè®¡)</label><input id="new-u-remark" placeholder="è¾“å…¥èŒä½æˆ–åœ°åŒºè¯¦æƒ…..."></div>
      </div>

      <div style="margin-top:15px; border-top:1px dashed #ddd; padding-top:10px;">
        <label style="margin-bottom:8px; font-weight:600;">å…è®¸æŸ¥çœ‹çš„è´¦ç›®èŒƒå›´ (ç®¡ç†å‘˜é»˜è®¤å…¨éƒ¨):</label>
        <div id="permission-checkboxes" style="display:flex; gap:20px; flex-wrap:wrap; font-size:13px;">
          <label><input type="checkbox" class="perm-check" value="trade"> è´¸æ˜“ä¸šåŠ¡</label>
          <label><input type="checkbox" class="perm-check" value="transport"> è¿è¾“ä¸šåŠ¡</label>
          <label><input type="checkbox" class="perm-check" value="plantation"> ç§æ¤ä¸šåŠ¡</label>
          <label><input type="checkbox" class="perm-check" value="cash_bank"> ç°é‡‘/é“¶è¡Œ(æ—¥å¸¸)</label>
          <label><input type="checkbox" class="perm-check" value="other"> å…¶ä»–/æ‚é¡¹</label>
        </div>
      </div>

      <button class="primary" style="width:100%; margin-top:15px;" onclick="addUser()">ä¿å­˜ç”¨æˆ·è®¾ç½®</button>
    </div>
    
    <div style="max-height:300px; overflow-y:auto; border: 1px solid var(--border); border-radius: 8px;">
        <table id="user-table"><thead><tr><th style="width:30%;">å§“å (ç”¨æˆ·å)</th><th style="width:40%;">è§’è‰²/æƒé™å¤‡æ³¨</th><th style="width:20%;">å¯†ç </th><th style="width:10%;">æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<div id="modal-edit" class="modal hidden">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="edit-modal-title">ç¼–è¾‘äº¤æ˜“è®°å½• (ID: <span id="edit-entry-id"></span>)</h3>
        <button class="secondary sm" onclick="document.getElementById('modal-edit').classList.add('hidden')">å…³é—­</button>
    </div>
    <div class="row">
        <div class="col"><label>æ—¥æœŸ</label><input type="date" id="edit-date"></div>
        <div class="col"><label>ç±»å‹</label><select id="edit-type"></select></div>
        <div class="col"><label>æŸç›Šç±»åˆ«</label><select id="edit-plCategory"></select></div>
        <div class="col"><label>è¯´æ˜</label><input type="text" id="edit-desc"></div>
    </div>
    <div class="row" style="margin-top:10px;">
        <div class="col"><label>ä¸»è´¦æˆ·</label><select id="edit-mainId"></select></div>
        <div class="col"><label>å¯¹æ–¹è´¦æˆ·</label><select id="edit-otherId"></select></div>
        <div class="col"><label style="color:var(--success)">æ”¶å…¥ (Income)</label><input type="number" id="edit-income" value="0" min="0" step="0.01"></div>
        <div class="col"><label style="color:var(--danger)">æ”¯å‡º (Expense)</label><input type="number" id="edit-expense" value="0" min="0" step="0.01"></div>
    </div>
    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center; border-top: 1px solid var(--border); padding-top: 10px;">
        <p style="font-size:12px; color:var(--text-sub);">åŸæ“ä½œäºº: <span id="edit-original-operator"></span> | æœ€åç¼–è¾‘: <span id="edit-last-edit"></span></p>
        <div>
            <button class="danger" id="btn-delete-entry">å½»åº•åˆ é™¤</button>
            <button class="primary" onclick="submitEdit()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
  </div>
</div>

<script>
/* ================= SYSTEM CORE V6.7 (å¼€æˆ·ç±»å‹è”åŠ¨ä¿®æ­£) ================= */
let DB = { version: "6.7", users: [], accounts: [], entries: [] };
let currentUser = null;
let currentMode = null;
let editingEntryId = null; 
let currentAccountFilterId = null; 

const GROUPS = { 
  cash_bank: "ç°é‡‘ä¸é“¶è¡Œ (æ—¥å¸¸)", 
  trade: "è´¸æ˜“ä¸šåŠ¡", 
  transport: "è¿è¾“ä¸šåŠ¡", 
  plantation: "ç§æ¤ä¸šåŠ¡", 
  other: "å…¶ä»– (æ‚é¡¹)" 
};
const KINDS = { 
  market: "è¶…å¸‚", canteen: "é£Ÿå ‚", supplier: "ä¾›åº”å•†", partner: "åˆä½œå•†", 
  staff: "å‘˜å·¥", customer: "å®¢æˆ·ç¾¤", bank: "é“¶è¡Œ", cash: "ç°é‡‘" 
};
const ROLES = {
    admin: "ç³»ç»Ÿç®¡ç†å‘˜",
    accountant: "ä¼šè®¡",
    shareholder: "è‚¡ä¸œ",
    agent: "åŒºä»£ç†"
};
const DEFAULT_PERMS = ['cash_bank', 'trade', 'transport', 'plantation', 'other'];

const PL_CATEGORIES = {
  'INC_SALE': 'ä¸»è¥ä¸šåŠ¡æ”¶å…¥', 'INC_OTHER': 'å…¶ä»–æ”¶å…¥/æ‚é¡¹',
  'EXP_COST': 'é‡‡è´­/æˆæœ¬', 'EXP_SALARY': 'è–ªèµ„/äººåŠ›æˆæœ¬',
  'EXP_RENT': 'ç§Ÿé‡‘/è¾¦å…¬è´¹ç”¨', 'EXP_TRAVEL': 'å·®æ—…è´¹',
  'EXP_UTILITY': 'æ°´ç”µç…¤ç½‘è´¹', 'EXP_MAINT': 'ç¶­ä¿®ä¿å…»è´¹',
  'EXP_TAX': 'ç¨è´¹', 'EXP_OTHER': 'å…¶ä»–æ”¯å‡º/æ‚é¡¹'
};

function init() {
  const saved = localStorage.getItem("AG_TRADE_DB_V5"); // ä¿æŒæ—§çš„å­˜å‚¨é”®åä»¥å…¼å®¹æ—§æ•°æ®
  if (saved) {
    try {
      DB = JSON.parse(saved);
      convertOldData(DB); // è¿è¡Œæ•°æ®å‡çº§/åˆå§‹åŒ–
      
      if(!DB.users || DB.users.length===0 || !DB.users.some(u => u.role === 'admin')) { 
        DB.users = [{id:uuid(), name:"Ivy Thien", username:"IVY1019", password:"000000", role:"admin", remark: "åˆå§‹ç®¡ç†å‘˜", allowedGroups: DEFAULT_PERMS}];
        saveDB(); 
      }
      showLogin();
    } catch(e) { showImportLayer(); }
  } else {
    DB.users = [{id:uuid(), name:"Ivy Thien", username:"IVY1019", password:"000000", role:"admin", remark: "åˆå§‹ç®¡ç†å‘˜", allowedGroups: DEFAULT_PERMS}];
    saveDB(); 
    showLogin();
  }
}

/**
 * V6.7 æ ¸å¿ƒï¼šæ•°æ®å‡çº§ä¸åˆå§‹åŒ–ï¼Œç¡®ä¿ LY/LN åˆ†ç»„æ­£ç¡®
 */
function convertOldData(db) {
  let changed = false;
  
  // 1. ç¡®ä¿ç‰ˆæœ¬å·æ›´æ–°æ—¶è¿›è¡Œå¿…è¦çš„å­—æ®µåˆå§‹åŒ–
  if (!db.version || db.version !== "6.7") {
    
    // åˆå§‹åŒ–/å‡çº§ç”¨æˆ·æ•°æ®
    db.users.forEach(u => {
      if (!u.role) u.role = u.username.toLowerCase().includes('admin') ? 'admin' : 'shareholder';
      if (!u.remark) u.remark = ROLES[u.role] || u.role;
      if (!u.allowedGroups) {
          u.allowedGroups = u.role === 'admin' ? DEFAULT_PERMS : ['cash_bank', 'trade'];
      }
    });

    // åˆå§‹åŒ–/å‡çº§äº¤æ˜“è®°å½•
    db.entries.forEach(e => {
      if (!e.plCategory) e.plCategory = '';
      if (!e.editedAt) e.editedAt = '';
      e.income = parseFloat((e.income || 0).toFixed(2));
      e.expense = parseFloat((e.expense || 0).toFixed(2));
    });

    db.version = "6.7";
    changed = true;
  }
  
  // 2. ç¡®ä¿æ‰€æœ‰è´¦æˆ·éƒ½æœ‰ group å­—æ®µ (å…¼å®¹æ—§æ•°æ®)
  db.accounts.forEach(acc => {
      if (!acc.group) {
        if (acc.kind === 'bank' || acc.kind === 'cash') acc.group = 'cash_bank';
        else if (['supplier', 'customer', 'partner', 'staff', 'market', 'canteen'].includes(acc.kind)) acc.group = 'trade'; 
        else acc.group = 'other';
      }
  });

  // 3. V6.6/V6.7 æ ¸å¿ƒä¿®æ­£ï¼šå¼ºåˆ¶å°†åç§°åŒ…å« LY/LN çš„è´¦æˆ·å½’åˆ°è´¸æ˜“ä¸šåŠ¡ (Trade)
  db.accounts.forEach(acc => {
      const accNameUpper = acc.name.toUpperCase();
      // æ£€æŸ¥åç§°æ˜¯å¦åŒ…å« LY æˆ– LN
      const isLY_LN = accNameUpper.includes('LY') || accNameUpper.includes('LN');
      
      // é¿å…ä¿®æ”¹åˆ°ç°é‡‘/é“¶è¡Œè´¦æˆ·ï¼Œä¸”ç¡®ä¿ LY/LN è´¦æˆ·è¢«å½’ç±»åˆ° trade
      if (isLY_LN && acc.group !== 'cash_bank') {
          if (acc.group !== 'trade') {
              acc.group = 'trade';
              changed = true;
          }
          // é¢å¤–çš„ä¿®æ­£ï¼šå¦‚æœ LY/LN è´¦æˆ·ç±»å‹æ˜¯ staff/customer/market/canteenï¼Œä¹Ÿåº”è§†ä¸º partner/supplier ç±»å‹çš„è´¸æ˜“ä¼™ä¼´
          if (acc.kind !== 'partner' && acc.kind !== 'supplier') {
              acc.kind = 'partner'; // å°†å…¶å½’ç±»ä¸º partner æ›´åˆé€‚
              changed = true;
          }
      }
      // ç¡®ä¿æ–°åŠ å…¥çš„ market/canteen è´¦æˆ·ä¹Ÿè¢«æ­£ç¡®å½’ç»„
      if (['market', 'canteen'].includes(acc.kind) && acc.group !== 'trade') {
          acc.group = 'trade';
          changed = true;
      }
  });

  if (changed) saveDB();
}

function saveDB() { localStorage.setItem("AG_TRADE_DB_V5", JSON.stringify(DB)); }
function uuid() { return 'id'+Date.now()+Math.floor(Math.random()*1000); }
function today() { return new Date().toISOString().split('T')[0]; }
function formatDateTime(isoString) {
    if (!isoString) return 'æ— ';
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}
function formatAmount(num) {
    return (num || 0).toFixed(2);
}
// V6.5 æ–°å¢ï¼šç”¨äºå¿«é€Ÿè®¾ç½®æ—¥æœŸå¹¶è§¦å‘æŸ¥è¯¢
function setDateRange(range) {
    let startStr = "", endStr = "";
    const now = new Date();
    
    if(range==='day') { startStr = today(); endStr = today(); } 
    else if(range==='month') { startStr = now.toISOString().slice(0,7) + '-01'; endStr = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]; } 
    else if(range==='week') { const d = new Date(); const dayOfWeek = (d.getDay() + 6) % 7; d.setDate(d.getDate() - dayOfWeek); startStr = d.toISOString().split('T')[0]; d.setDate(d.getDate() + 6); endStr = d.toISOString().split('T')[0]; }
    
    document.getElementById('dash-start').value = startStr;
    document.getElementById('dash-end').value = endStr;
    renderApp();
}

/* ================= LOGIN & UI ================= */
function showImportLayer() { 
  document.getElementById('layer-import').classList.remove('hidden'); 
  document.getElementById('layer-login').classList.add('hidden');
}
function triggerImport() { document.getElementById('file-import').click(); }
function triggerImportBtn() { document.getElementById('file-import-btn').click(); }
function handleFileImport(input) {
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const json = JSON.parse(e.target.result);
      DB.users = json.users || [];
      DB.accounts = json.accounts || [];
      DB.entries = json.entries || [];
      convertOldData(DB);
      saveDB(); alert("å¯¼å…¥æˆåŠŸ"); location.reload();
    } catch(e) { alert("æ–‡ä»¶æ— æ•ˆ"); }
  };
  reader.readAsText(file);
}

function showLogin() {
  document.getElementById('layer-import').classList.add('hidden');
  document.getElementById('layer-login').classList.remove('hidden');
  document.getElementById('login-user-input').value = ""; 
  document.getElementById('login-pass').value = "";
  document.getElementById('login-user-input').focus();
}

function doLogin() {
  const uNameInput = document.getElementById('login-user-input').value.trim();
  const passInput = document.getElementById('login-pass').value.trim();
  const u = DB.users.find(x => x.username.toLowerCase() === uNameInput.toLowerCase() && x.password === passInput);
  
  if(u) {
    currentUser = u;
    const userRoleText = ROLES[u.role] || u.role;
    const remarkText = u.remark ? ` (${u.remark})` : '';
    document.getElementById('display-user').textContent = `${u.name} (${userRoleText})${remarkText}`;
    document.getElementById('layer-login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    setDateRange('day'); // é»˜è®¤æ˜¾ç¤ºä»Šæ—¥æ•°æ®
    updateUIPermissions(); 
  } else document.getElementById('login-msg').textContent = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯";
}

function doLogout() { currentUser=null; location.reload(); }
function systemReset() { 
  if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é‡ç½®ç³»ç»Ÿã€‚');
  if(!confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦å½»åº•é‡ç½®ç³»ç»Ÿå—ï¼Ÿæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼")) return;
  localStorage.removeItem("AG_TRADE_DB_V5");
  location.reload();
}

function renderApp() {
  const start = document.getElementById('dash-start').value;
  const end = document.getElementById('dash-end').value;

  renderAccounts();
  renderReport(start, end); 
  renderLedger(start, end);
}

/**
 * V6.6 æ ¸å¿ƒï¼šæ ¹æ®ç”¨æˆ·è§’è‰²å’Œæƒé™è¿‡æ»¤ UI å…ƒç´ 
 */
function updateUIPermissions() {
    const isEditor = currentUser.role === 'admin' || currentUser.role === 'accountant';
    const isAdmin = currentUser.role === 'admin';
    const isViewer = currentUser.role === 'shareholder' || currentUser.role === 'agent';
    
    // 1. å¿«é€Ÿæ“ä½œå¡ç‰‡
    document.getElementById('quick-action-card').style.display = isEditor ? 'block' : 'none';
    
    // 2. é¡¶éƒ¨ç®¡ç†æŒ‰é’®
    document.querySelectorAll('.top-bar button').forEach(btn => {
        const text = btn.textContent;
        if (text.includes('ç³»ç»Ÿé‡ç½®') || text.includes('ç®¡ç†äººå‘˜')) {
             btn.style.display = isAdmin ? 'inline-block' : 'none';
        }
    });

    // 3. è´¦ç›®æ˜ç»†æ“ä½œæŒ‰é’®
    document.getElementById('btn-delete-all').style.display = isAdmin ? 'inline-block' : 'none';
}

/**
 * V6.6 æ ¸å¿ƒï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæŸ¥çœ‹è¯¥ Group çš„äº¤æ˜“æˆ–è´¦æˆ·
 */
function canUserViewGroup(groupKey) {
    if (currentUser.role === 'admin') return true; 
    
    if (!currentUser.allowedGroups) return false;
    
    return currentUser.allowedGroups.includes(groupKey);
}

function getAccountIdsInFilter() {
    return DB.accounts.filter(a => canUserViewGroup(a.group)).map(a => a.id);
}

/* ================= è´¦æˆ·åˆ—è¡¨ (V6.6: æƒé™è¿‡æ»¤) ================= */
let dragSrcEl = null;

function renderAccounts() {
  const container = document.getElementById('acc-list-container');
  container.innerHTML = '';
  const groupedAccounts = {};
  
  // åˆå§‹åŒ–æ‰€æœ‰ç»„
  Object.keys(GROUPS).forEach(k => groupedAccounts[k] = []);
  
  // ä»…æ˜¾ç¤ºæœ‰æƒé™æŸ¥çœ‹çš„è´¦æˆ·
  DB.accounts.forEach(acc => {
    const groupKey = acc.group; 
    if (canUserViewGroup(groupKey)) {
      if (!groupedAccounts[groupKey]) groupedAccounts[groupKey] = [];
      groupedAccounts[groupKey].push(acc);
    }
  });

  Object.keys(GROUPS).forEach(groupKey => {
    const list = groupedAccounts[groupKey];
    if (!list || list.length === 0) return;
    
    const div = document.createElement('div');
    div.className = 'acc-group';
    div.dataset.group = groupKey; 
    div.innerHTML = `<h4>${GROUPS[groupKey] || groupKey} (${list.length})</h4>`;
    
    list.forEach(acc => {
      const item = document.createElement('div');
      item.className = 'acc-item';
      if (acc.id === currentAccountFilterId) item.classList.add('selected'); 
      item.draggable = (currentUser.role === 'admin'); // åªæœ‰ç®¡ç†å‘˜èƒ½æ‹–æ‹½
      item.dataset.id = acc.id;
      item.dataset.group = acc.group; 
      
      let controlsHtml = '';
      const canEdit = currentUser.role === 'admin' || currentUser.role === 'accountant';
      const canDelete = currentUser.role === 'admin';
      
      if (canEdit) {
          controlsHtml += `<span class="btn-icon edit" onclick="editAccount('${acc.id}', event)">âœ</span>`;
      }
      if (canDelete) {
          controlsHtml += `<span class="btn-icon del" onclick="deleteAccount('${acc.id}', event)">Ã—</span>`;
      }
      if (controlsHtml !== '') {
          controlsHtml = `<div class="acc-controls">${controlsHtml}</div>`;
      }

      item.onclick = (e) => toggleAccountFilter(acc.id); 
      item.innerHTML = `
        <div style="display:flex; flex-direction:column; width:100%;">
            <span style="font-size:12px; display:flex; justify-content:space-between;">
                ${acc.name}
                ${controlsHtml}
            </span>
            <span class="acc-bal ${acc.balance<0?'neg':''}">${formatAmount(acc.balance)}</span>
        </div>
      `;
      addDragEvents(item);
      div.appendChild(item);
    });
    container.appendChild(div);
  });
}

function toggleAccountFilter(accId) {
    if (currentAccountFilterId === accId) currentAccountFilterId = null; 
    else currentAccountFilterId = accId;
    renderAccounts(); renderLedger(); 
}

function editAccount(id, event) {
    event.stopPropagation();
    if (currentUser.role !== 'admin' && currentUser.role !== 'accountant') return alert("æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜æˆ–ä¼šè®¡å¯ä»¥ä¿®æ”¹è´¦æˆ·ã€‚");
    const acc = DB.accounts.find(a => a.id === id);
    if (!acc) return;
    const newName = prompt("è¯·è¾“å…¥æ–°çš„è´¦æˆ·åç§°:", acc.name);
    if (newName && newName.trim() !== "") {
        acc.name = newName.trim();
        saveDB(); renderAccounts(); renderLedger();
    }
}

function deleteAccount(id, event) {
    event.stopPropagation();
    if (currentUser.role !== 'admin') return alert("æƒé™ä¸è¶³ï¼šä»…ç®¡ç†å‘˜å¯åˆ é™¤è´¦æˆ·ã€‚");
    
    const acc = DB.accounts.find(a => a.id === id);
    if (!acc) return;

    const hasEntries = DB.entries.some(e => e.mainId === id || e.otherId === id);
    if (hasEntries) {
        return alert(`æ— æ³•åˆ é™¤è´¦æˆ· "${acc.name}"ï¼Œå› ä¸ºå®ƒåŒ…å«äº¤æ˜“è®°å½•ã€‚`);
    }

    if (confirm(`ç¡®å®šè¦åˆ é™¤è´¦æˆ· "${acc.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        DB.accounts = DB.accounts.filter(a => a.id !== id);
        saveDB(); renderAccounts();
    }
}

function addDragEvents(item) {
  item.addEventListener('dragstart', function(e) { 
    if (currentUser.role !== 'admin') { e.preventDefault(); return; } 
    dragSrcEl = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; 
  });
  item.addEventListener('dragend', function(e) { this.classList.remove('dragging'); document.querySelectorAll('.acc-item').forEach(el => el.classList.remove('drag-over')); });
  item.addEventListener('dragover', function(e) { 
    e.preventDefault(); 
    if(dragSrcEl !== this && dragSrcEl.dataset.group === this.dataset.group && currentUser.role === 'admin') { 
        this.classList.add('drag-over'); 
    }
    return false; 
  });
  item.addEventListener('drop', function(e) {
    e.stopPropagation();
    if (dragSrcEl !== this && dragSrcEl.dataset.group === this.dataset.group && currentUser.role === 'admin') { 
      const srcId = dragSrcEl.dataset.id;
      const targetId = this.dataset.id;
      const srcIdxInFull = DB.accounts.findIndex(a => a.id === srcId);
      const targetIdxInFull = DB.accounts.findIndex(a => a.id === targetId);
      if(srcIdxInFull > -1 && targetIdxInFull > -1) {
          const [movedItem] = DB.accounts.splice(srcIdxInFull, 1);
          DB.accounts.splice(targetIdxInFull, 0, movedItem);
          saveDB(); renderAccounts();
      }
    }
    return false;
  });
}

/* ================= è´¦ç›®æ˜ç»† (V6.6: æƒé™è¿‡æ»¤ä¸æ—¥æœŸè”åŠ¨) ================= */
function getAccName(id) {
  const acc = DB.accounts.find(a => a.id === id);
  return acc ? acc.name : (id ? 'æœªçŸ¥è´¦æˆ·' : '-');
}

function getAccGroup(id) {
    const acc = DB.accounts.find(a => a.id === id);
    return acc ? acc.group : 'other'; // é»˜è®¤ç»™ other
}

function getAccTooltip(id) {
  const acc = DB.accounts.find(a => a.id === id);
  if (!acc || !acc.balance) return '';
  const balanceText = `å½“å‰ä½™é¢: ${formatAmount(acc.balance)}`;
  const accTypeText = `è´¦æˆ·ç±»å‹: ${KINDS[acc.kind] || 'N/A'}`;
  return `title="${balanceText} | ${accTypeText}" style="cursor: pointer; text-decoration: underline dotted; color: ${acc.balance < 0 ? 'var(--danger)' : 'var(--success)'};"`;
}

function renderLedger(startDate, endDate) {
  const tbody = document.querySelector('#ledger-table tbody');
  tbody.innerHTML = '';
  const search = document.getElementById('search-input').value.toLowerCase();
  const isEditor = currentUser.role === 'admin' || currentUser.role === 'accountant';
  
  let filteredEntries = DB.entries.filter(e => {
    
    // V6.6 æ ¸å¿ƒï¼šæƒé™è¿‡æ»¤
    const mainGroup = getAccGroup(e.mainId);
    const otherGroup = getAccGroup(e.otherId);
    
    // å¦‚æœäº¤æ˜“æ¶‰åŠçš„ä¸¤ä¸ªè´¦æˆ·ï¼Œä¸»è´¦æˆ·/å…¶ä»–è´¦æˆ·ï¼Œåªè¦æœ‰ä¸€ä¸ªåœ¨ç”¨æˆ·çš„å…è®¸æŸ¥çœ‹èŒƒå›´å†…ï¼Œåˆ™æ˜¾ç¤ºã€‚
    if (!canUserViewGroup(mainGroup) && !canUserViewGroup(otherGroup)) {
        return false;
    }

    // V6.6 æ ¸å¿ƒï¼šæ—¥æœŸå’Œæœç´¢è¿‡æ»¤
    if (startDate && e.date < startDate) return false;
    if (endDate && e.date > endDate) return false;
    
    if (currentAccountFilterId && e.mainId !== currentAccountFilterId && e.otherId !== currentAccountFilterId) return false;
    
    if(search) {
      const mainName = getAccName(e.mainId).toLowerCase();
      const otherName = getAccName(e.otherId).toLowerCase();
      if (!e.desc.toLowerCase().includes(search) && !mainName.includes(search) && !otherName.includes(search)) return false;
    }
    return true;
  });

  filteredEntries.sort((a, b) => {
    if (a.date < b.date) return 1; if (a.date > b.date) return -1;
    if (a.id < b.id) return 1; if (a.id > b.id) return -1;
    return 0;
  });
  
  filteredEntries.forEach(e => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.type}</td>
      <td>${e.desc || '-'}</td>
      <td ${getAccTooltip(e.mainId)} onclick="toggleAccountFilter('${e.mainId}')">${getAccName(e.mainId)}</td> 
      <td>${getAccName(e.otherId)}</td>
      <td style="color:${e.income>0?'var(--success)':'#ccc'}">${formatAmount(e.income)}</td>
      <td style="color:${e.expense>0?'var(--danger)':'#ccc'}">${formatAmount(e.expense)}</td>
      <td>${e.operator}</td>
      <td>${isEditor ? `<button class="secondary sm" onclick="showEditModal('${e.id}')">ç¼–è¾‘</button>` : '---'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function clearAllFilters() {
    currentAccountFilterId = null;
    document.getElementById('search-input').value = '';
    // ä¸æ¸…ç©º dash-start/end, ä¿æŒå½“å‰æŠ¥è¡¨ç­›é€‰çŠ¶æ€
    renderAccounts(); renderLedger();
}

function deleteAllRecords() {
    if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ é™¤å…¨éƒ¨è®°å½•ã€‚');
    if (!confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦åˆ é™¤å½“å‰æ‰€æœ‰è´¦ç›®è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;
    DB.entries.forEach(e => reverseTransactionEffect(e)); 
    DB.entries = [];
    saveDB(); renderApp();
}

/* ================= ç¼–è¾‘ç³»ç»Ÿ ================= */
function showEditModal(entryId) {
  if (currentUser.role !== 'admin' && currentUser.role !== 'accountant') return alert('æ‚¨çš„è§’è‰²æ— æƒè¿›è¡Œäº¤æ˜“ä¿®æ”¹æ“ä½œã€‚');
  
  const entry = DB.entries.find(e => e.id === entryId);
  if (!entry) return alert('è®°å½•ä¸å­˜åœ¨');
  
  // V6.6 æƒé™æ£€æŸ¥ï¼šç¡®ä¿ç”¨æˆ·æœ‰æƒé™ç¼–è¾‘è¿™æ¡è®°å½•
  const mainGroup = getAccGroup(entry.mainId);
  const otherGroup = getAccGroup(entry.otherId);
  if (!canUserViewGroup(mainGroup) && !canUserViewGroup(otherGroup)) {
      return alert('æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒç¼–è¾‘æ¶‰åŠæ­¤ä¸šåŠ¡ç»„çš„äº¤æ˜“è®°å½•ã€‚');
  }

  editingEntryId = entryId;

  document.getElementById('edit-entry-id').textContent = entryId;
  document.getElementById('edit-date').value = entry.date;
  document.getElementById('edit-desc').value = entry.desc || '';
  document.getElementById('edit-income').value = formatAmount(entry.income);
  document.getElementById('edit-expense').value = formatAmount(entry.expense);
  document.getElementById('edit-original-operator').textContent = entry.operator;
  document.getElementById('edit-last-edit').textContent = formatDateTime(entry.editedAt);
  
  fillSelect('edit-type', ['æ”¶å…¥','æ”¯å‡º','åº”æ”¶å¢åŠ ','æ”¶åº”æ”¶','åº”ä»˜å¢åŠ ','æ”¯ä»˜åº”ä»˜','è½¬è´¦','æœŸåˆ'], entry.type);
  fillSelect('edit-plCategory', Object.keys(PL_CATEGORIES), entry.plCategory, PL_CATEGORIES);
  fillAccountSelect('edit-mainId', entry.mainId);
  fillAccountSelect('edit-otherId', entry.otherId);

  // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤
  document.getElementById('btn-delete-entry').style.display = (currentUser.role === 'admin' ? 'inline-block' : 'none');
  document.getElementById('btn-delete-entry').onclick = () => { deleteEntry(entryId); document.getElementById('modal-edit').classList.add('hidden'); };
  document.getElementById('modal-edit').classList.remove('hidden');
}

function fillSelect(id, values, selectedValue, map = null) {
  const select = document.getElementById(id);
  select.innerHTML = '';
  select.add(new Option('---', ''));
  values.forEach(val => {
    const text = map ? map[val] : val;
    const option = new Option(text, val);
    if (val === selectedValue) option.selected = true;
    select.add(option);
  });
}

function fillAccountSelect(id, selectedAccId) {
  const select = document.getElementById(id);
  select.innerHTML = '';
  select.add(new Option('---', ''));
  
  DB.accounts.forEach(acc => {
    // V6.6 æƒé™è¿‡æ»¤ï¼šç¼–è¾‘æ—¶åªèƒ½é€‰æ‹©è‡ªå·±èƒ½çœ‹åˆ°çš„è´¦æˆ·
    if (canUserViewGroup(acc.group) || acc.id === selectedAccId) {
        const option = new Option(acc.name, acc.id);
        if (acc.id === selectedAccId) option.selected = true;
        select.add(option);
    }
  });
}

function submitEdit() {
  const id = editingEntryId;
  const entry = DB.entries.find(e => e.id === id);
  if (!entry) return;

  const newEntry = {
    date: document.getElementById('edit-date').value,
    type: document.getElementById('edit-type').value,
    plCategory: document.getElementById('edit-plCategory').value,
    desc: document.getElementById('edit-desc').value,
    mainId: document.getElementById('edit-mainId').value,
    otherId: document.getElementById('edit-otherId').value,
    income: parseFloat(parseFloat(document.getElementById('edit-income').value) || 0),
    expense: parseFloat(parseFloat(document.getElementById('edit-expense').value) || 0)
  };
  
  if (!newEntry.date || !newEntry.type || !newEntry.mainId || (newEntry.income===0 && newEntry.expense===0)) return alert("è¯·ç¡®ä¿æ—¥æœŸã€ç±»å‹ã€ä¸»è´¦æˆ·ã€æ”¶å…¥æˆ–æ”¯å‡ºé‡‘é¢å·²å¡«å†™ï¼");
  
  reverseTransactionEffect(entry); 
  Object.assign(entry, newEntry);
  
  // V6.6 æ ¸å¿ƒï¼šå¼ºåˆ¶å®¡è®¡ç•™ç—•
  let operatorText = entry.operator.replace(/ \(ä¿®æ”¹äºº:.*?\)/, ''); // æ¸…ç†æ—§çš„ç¼–è¾‘æ ‡è®°
  if (currentUser.role === 'accountant') {
      entry.operator = `${operatorText} (ä¿®æ”¹äºº: ${currentUser.name})`; 
  } else if (currentUser.role === 'admin') {
       entry.operator = `${operatorText} (ç®¡ç†å‘˜ç¼–è¾‘)`;
  }
  
  entry.editedAt = new Date().toISOString(); 
  applyTransactionEffect(entry);

  saveDB(); 
  document.getElementById('modal-edit').classList.add('hidden');
  renderApp();
}

function updateBalance(id, delta) {
  if(!id) return;
  const acc = DB.accounts.find(a => a.id === id);
  if (acc) acc.balance = parseFloat(formatAmount(acc.balance + delta));
}

function applyTransactionEffect(e) {
  const main = e.mainId; const other = e.otherId;
  const inc = e.income || 0; const exp = e.expense || 0;
  if (e.type === "æ”¶å…¥") updateBalance(main, inc);
  else if (e.type === "æ”¯å‡º") updateBalance(main, -exp);
  else if (e.type === "åº”æ”¶å¢åŠ ") updateBalance(main, inc);
  else if (e.type === "æ”¶åº”æ”¶") { updateBalance(main, -inc); updateBalance(other, inc); }
  else if (e.type === "åº”ä»˜å¢åŠ ") updateBalance(main, -exp);
  else if (e.type === "æ”¯ä»˜åº”ä»˜") { updateBalance(main, exp); updateBalance(other, -exp); }
  else if (e.type === "è½¬è´¦") { updateBalance(main, -exp); updateBalance(other, exp); }
  else if (e.type === "æœŸåˆ") { updateBalance(main, (inc - exp)); }
  if (e.type === "è½¬è´¦" && inc > 0 && exp === 0) { updateBalance(main, -inc); updateBalance(other, inc); }
}

function reverseTransactionEffect(e) {
  const main = e.mainId; const other = e.otherId;
  const inc = e.income || 0; const exp = e.expense || 0;
  if (e.type === "æ”¶å…¥") updateBalance(main, -inc);
  else if (e.type === "æ”¯å‡º") updateBalance(main, exp);
  else if (e.type === "åº”æ”¶å¢åŠ ") updateBalance(main, -inc);
  else if (e.type === "æ”¶åº”æ”¶") { updateBalance(main, inc); updateBalance(other, -inc); }
  else if (e.type === "åº”ä»˜å¢åŠ ") updateBalance(main, exp);
  else if (e.type === "æ”¯ä»˜åº”ä»˜") { updateBalance(main, -exp); updateBalance(other, exp); }
  else if (e.type === "è½¬è´¦") { updateBalance(main, exp); updateBalance(other, -exp); }
  else if (e.type === "æœŸåˆ") { updateBalance(main, -(inc - exp)); }
  if (e.type === "è½¬è´¦" && inc > 0 && exp === 0) { updateBalance(main, inc); updateBalance(other, -inc); }
}

function deleteEntry(id) {
  if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤äº¤æ˜“è®°å½•ã€‚');
  if(!confirm(`âš ï¸ è­¦å‘Šï¼šåˆ é™¤è®°å½• (${id}) å°†å›æ»šä½™é¢ï¼Œç¡®å®šå½»åº•åˆ é™¤å—ï¼Ÿ`)) return; 
  const idx = DB.entries.findIndex(e => e.id === id);
  if(idx > -1) {
    reverseTransactionEffect(DB.entries[idx]);
    DB.entries.splice(idx, 1);
    saveDB(); renderApp();
  }
}

/* ================= TRANSACTION LOGIC ================= */
// V6.7 æ–°å¢ï¼šåŠ¨æ€æ›´æ–° Kind é€‰é¡¹
function updateKindOptions() {
    const groupSelect = document.getElementById('new-group');
    const kindSelect = document.getElementById('new-kind');
    if (!groupSelect || !kindSelect) return;

    const selectedGroup = groupSelect.value;
    let eligibleKinds = {};

    if (selectedGroup === 'cash_bank') {
        // ç°é‡‘/é“¶è¡Œç»„åªæ˜¾ç¤º ç°é‡‘/é“¶è¡Œ ä¸¤ç§ç±»å‹
        eligibleKinds = { cash: KINDS.cash, bank: KINDS.bank };
    } else if (selectedGroup !== '') {
        // å…¶ä»–ä¸šåŠ¡ç»„åªæ˜¾ç¤º éç°é‡‘/é“¶è¡Œ çš„ç±»å‹
        Object.entries(KINDS).forEach(([key, name]) => {
            if (key !== 'cash' && key !== 'bank') {
                eligibleKinds[key] = name;
            }
        });
    }
    
    // é‡æ–°å¡«å…… Kind Select
    kindSelect.innerHTML = '<option value="">--- è¯·é€‰æ‹©ç±»å‹ ---</option>';
    Object.entries(eligibleKinds).forEach(([key, name]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = name;
        kindSelect.appendChild(option);
    });
    
    // å¦‚æœåªæœ‰ä¸€ç§æœ‰æ•ˆç±»å‹ï¼ˆä¸å¸¸ç”¨ï¼Œä½†ç¡®ä¿é€»è¾‘å®Œæ•´ï¼‰
    if (Object.keys(eligibleKinds).length === 1) {
        kindSelect.value = Object.keys(eligibleKinds)[0];
    }
}

function setMode(mode) {
  if (currentUser.role !== 'admin' && currentUser.role !== 'accountant') return alert('æ‚¨çš„è§’è‰²æ— æƒè¿›è¡Œäº¤æ˜“å½•å…¥æ“ä½œã€‚');
  
  currentMode = mode;
  const container = document.getElementById('form-inputs');
  const btn = document.getElementById('btn-submit');
  const title = document.getElementById('form-title');
  container.innerHTML = '';
  btn.classList.remove('hidden');

  // V6.6 ä¿®æ­£ï¼šæ›´æ–° AR/AP çš„è´¦æˆ· Kind ç­›é€‰åˆ—è¡¨
  const IN_KINDS = ['bank','cash','customer', 'market', 'canteen']; // æ”¶å…¥ï¼šæ¥è‡ªæ‰€æœ‰å®¢æˆ·å’Œç°é‡‘/é“¶è¡Œ
  const OUT_KINDS = ['bank','cash'];
  const AR_KINDS = ['customer','supplier','partner', 'market', 'canteen']; // åº”æ”¶ï¼šæ‰€æœ‰éé“¶è¡Œ/å‘˜å·¥çš„è´¦æˆ·
  const AP_KINDS = ['supplier','partner', 'market', 'canteen', 'customer']; // åº”ä»˜ï¼šæ‰€æœ‰éé“¶è¡Œ/å‘˜å·¥çš„è´¦æˆ· (å®¢æˆ·ä¹Ÿå¯èƒ½è¢«åº”ä»˜)

  const createSelect = (id, label, filterKind) => {
    let opts = '<option value="">--- è¯·é€‰æ‹© ---</option>';
    
    // V6.6: è´¦æˆ·åˆ—è¡¨æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤
    let eligibleAccs = DB.accounts.filter(acc => canUserViewGroup(acc.group) && (!filterKind || filterKind.includes(acc.kind)));
    eligibleAccs.sort((a, b) => a.kind.localeCompare(b.kind));

    let lastKind = "";
    eligibleAccs.forEach(acc => {
        if (acc.kind !== lastKind) {
            if (lastKind !== "") opts += `<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>`;
            opts += `<option disabled style="font-weight:bold; color:#666; font-size:12px;">-- ${KINDS[acc.kind] || acc.kind} --</option>`;
            lastKind = acc.kind;
        }
        opts += `<option value="${acc.id}"> &nbsp;&nbsp; ${acc.name}</option>`;
    });

    return `<div class="col"><label>${label}</label><select id="${id}">${opts}</select></div>`;
  };
  
  const createInput = (id, label, type="text") => {
      let inputHtml = `<input id="${id}" type="${type}">`;
      if (type === 'number') inputHtml = `<input id="${id}" type="${type}" min="0" step="0.01" value="">`;
      return `<div class="col"><label>${label}</label>${inputHtml}</div>`;
  };
  
  let html = "";
  
  if (mode !== 'OPEN_ACC') {
      html = createInput('tx-date', 'æ—¥æœŸ', 'date');
  }

  if(mode === 'IN') { title.innerText="ğŸ’° æ”¶å…¥"; html += createSelect('tx-acc', 'è´¦æˆ·', OUT_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'OUT') { title.innerText="ğŸ’¸ æ”¯å‡º"; html += createSelect('tx-acc', 'è´¦æˆ·', OUT_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AR_ADD') { title.innerText="ğŸ“ åº”æ”¶æŒ‚è´¦"; html += createSelect('tx-acc', 'æ¬ æ¬¾äºº', AR_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AR_GET') { title.innerText="âœ… æ”¶å›åº”æ”¶"; html += createSelect('tx-acc', 'è¿˜æ¬¾äºº', AR_KINDS) + createSelect('tx-to','æ”¶æ¬¾è´¦æˆ·', OUT_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AP_ADD') { title.innerText="ğŸ“ åº”ä»˜èµŠè´¦"; html += createSelect('tx-acc', 'å€ºæƒäºº', AP_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'AP_PAY') { title.innerText="ğŸ§§ æ”¯ä»˜åº”ä»˜"; html += createSelect('tx-acc', 'æ”¶æ¬¾äºº', AP_KINDS) + createSelect('tx-to','ä»˜æ¬¾è´¦æˆ·', OUT_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'TRANSFER') { title.innerText="ğŸ”„ è½¬è´¦"; html += createSelect('tx-from', 'è½¬å‡º', OUT_KINDS) + createSelect('tx-to', 'è½¬å…¥', OUT_KINDS) + createInput('tx-amt','é‡‘é¢','number'); }
  else if(mode === 'OPEN_ACC') { 
    title.innerText="â• å¼€æˆ·"; 
    let groupOpts = '<option value="">--- è¯·é€‰æ‹©åˆ†ç»„ ---</option>';
    // V6.6 æƒé™è¿‡æ»¤ï¼šå¼€æˆ·æ—¶ä¹Ÿåªèƒ½é€‰æ‹©è‡ªå·±èƒ½ç®¡ç†çš„ Group (Adminæ‰å¯ä»¥çœ‹åˆ°æ‰€æœ‰)
    Object.entries(GROUPS).forEach(([key, name]) => { 
        if(currentUser.role === 'admin' || currentUser.allowedGroups.includes(key)) {
            groupOpts += `<option value="${key}">${name}</option>`; 
        }
    });

    html = createInput('new-date', 'å¼€æˆ·æ—¥æœŸ', 'date')
    // V6.7 æ ¸å¿ƒä¿®æ­£ï¼šæ·»åŠ  onchange äº‹ä»¶ï¼Œå¹¶å»é™¤ Kind é€‰é¡¹çš„åˆå§‹å¡«å……
    + `<div class="col"><label>åˆ†ç»„</label><select id="new-group" onchange="updateKindOptions()">${groupOpts}</select></div>` 
    + `<div class="col"><label>ç±»å‹</label><select id="new-kind"><option value="">--- è¯·å…ˆé€‰æ‹©åˆ†ç»„ ---</option></select></div>` 
    + createInput('new-name','åç§°') 
    + createInput('new-bal','åˆå§‹ä½™é¢','number'); 
  }
  
  if(mode !== 'OPEN_ACC' && mode !== 'TRANSFER') {
    let plOpts = '<option value="">-- é€‰æ‹©æŸç›Šç±»åˆ«ï¼ˆå¿…é€‰ï¼‰ --</option>';
    const filter = (mode === 'IN' || mode === 'AR_ADD' || mode === 'AR_GET') ? 'INC_' : 'EXP_'; 
    Object.entries(PL_CATEGORIES).forEach(([key, name]) => {
      if(key.startsWith(filter)) plOpts += `<option value="${key}">${name}</option>`;
    });
    html += `<div class="col" style="flex:1 1 100%;"><label>æŸç›Šç±»åˆ«</label><select id="tx-pl-category">${plOpts}</select></div>`; 
    html += createInput('tx-desc', 'è¯´æ˜');
  } else if (mode === 'TRANSFER') {
      html += createInput('tx-desc', 'è¯´æ˜');
  }
  
  container.innerHTML = html;
  
  setTimeout(() => {
    if(document.getElementById('tx-date')) document.getElementById('tx-date').value = today();
    if(document.getElementById('new-date')) document.getElementById('new-date').value = today();
    
    // V6.7 æ ¸å¿ƒä¿®æ­£ï¼šå¼€æˆ·æ—¶è°ƒç”¨è”åŠ¨å‡½æ•°
    if(document.getElementById('new-group')) updateKindOptions(); 

    const focusEl = document.getElementById('tx-amt') || document.getElementById('new-name');
    if(focusEl) focusEl.focus();
  }, 50);
  
  container.onkeyup = (e) => { if(e.key === 'Enter') submitTransaction(); };
}

function submitTransaction() {
  const dateInput = document.getElementById('new-date') || document.getElementById('tx-date');
  const date = dateInput ? dateInput.value : today();

  let entry = { 
    id: uuid(), date: date, operator: currentUser.name, // å½•å…¥æ—¶ä½¿ç”¨åå­—
    type:"", desc:"", mainId:"", otherId:"", income:0, expense:0,
    plCategory: "", editedAt: ""
  };

  if(currentMode === 'OPEN_ACC') {
    const name = document.getElementById('new-name').value;
    const kind = document.getElementById('new-kind').value;
    const group = document.getElementById('new-group').value;
    const bal = parseFloat(parseFloat(document.getElementById('new-bal').value) || 0); 
    
    // V6.7 ä¿®æ­£ï¼šå¼ºåˆ¶é€‰æ‹© Kind
    if(!name || !group || !kind) return alert("è¯·å¡«å†™å®Œæ•´çš„å¼€æˆ·ä¿¡æ¯ (åˆ†ç»„å’Œç±»å‹å¿…é¡»é€‰æ‹©)ã€‚");

    const newAcc = { id: uuid(), name, kind, group, balance: bal };
    DB.accounts.push(newAcc);
    
    if(bal !== 0) {
      entry.type="æœŸåˆ"; entry.desc="åˆå§‹ä½™é¢"; entry.mainId=newAcc.id; 
      if(bal>0) entry.income=bal; else entry.expense=Math.abs(bal);
      entry.plCategory = 'æœŸåˆä½™é¢';
      DB.entries.unshift(entry);
    }

  } else {
    const amt = parseFloat(parseFloat(document.getElementById('tx-amt').value));
    const desc = document.getElementById('tx-desc').value;
    const plCategory = document.getElementById('tx-pl-category') ? document.getElementById('tx-pl-category').value : '';

    if(isNaN(amt) || amt<=0) return alert("é‡‘é¢é”™è¯¯æˆ–æœªå¡«å†™ã€‚é‡‘é¢å¿…é¡»å¤§äº0ã€‚");
    if(!plCategory && currentMode !== 'TRANSFER') return alert("è¯·é€‰æ‹©æŸç›Šç±»åˆ«");
    
    entry.desc = desc;
    entry.plCategory = plCategory;

    const main = document.getElementById('tx-acc') ? document.getElementById('tx-acc').value : document.getElementById('tx-from').value;
    const other = document.getElementById('tx-to') ? document.getElementById('tx-to').value : "";
    
    if(!main) return alert("è¯·é€‰æ‹©è´¦æˆ·ï¼");
    if(currentMode === 'TRANSFER' && !other) return alert("è¯·é€‰æ‹©è½¬å…¥è´¦æˆ·ï¼");

    entry.mainId = main; entry.otherId = other;
    
    if(currentMode==='IN') { entry.type="æ”¶å…¥"; entry.income=amt; updateBalance(main, amt); }
    else if(currentMode==='OUT') { entry.type="æ”¯å‡º"; entry.expense=amt; updateBalance(main, -amt); }
    else if(currentMode==='AR_ADD') { entry.type="åº”æ”¶å¢åŠ "; entry.income=amt; updateBalance(main, amt); }
    else if(currentMode==='AR_GET') { entry.type="æ”¶åº”æ”¶"; entry.income=amt; updateBalance(main, -amt); updateBalance(other, amt); }
    else if(currentMode==='AP_ADD') { entry.type="åº”ä»˜å¢åŠ "; entry.expense=amt; updateBalance(main, -amt); }
    else if(currentMode==='AP_PAY') { entry.type="æ”¯ä»˜åº”ä»˜"; entry.expense=amt; updateBalance(main, amt); updateBalance(other, -amt); }
    else if(currentMode==='TRANSFER') { entry.type="è½¬è´¦"; entry.expense=amt; updateBalance(main, -amt); updateBalance(other, amt); }
    
    DB.entries.unshift(entry);
  }
  
  saveDB(); renderApp();

  // è‡ªåŠ¨å½’é›¶å’Œé‡ç½®
  if(document.getElementById('tx-amt')) document.getElementById('tx-amt').value = '';
  if(document.getElementById('tx-desc')) document.getElementById('tx-desc').value = '';
  if(document.getElementById('new-name')) document.getElementById('new-name').value = '';
  if(document.getElementById('new-bal')) document.getElementById('new-bal').value = '';
  
  if(document.getElementById('tx-date')) document.getElementById('tx-date').value = today();
  if(document.getElementById('new-date')) document.getElementById('new-date').value = today();

  ['tx-acc', 'tx-from', 'tx-to', 'tx-pl-category'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.value = "";
  });

  const focusEl = document.getElementById('tx-acc') || document.getElementById('tx-from') || document.getElementById('new-name');
  if(focusEl) focusEl.focus();

  const btn = document.getElementById('btn-submit');
  btn.innerText = "å·²ä¿å­˜ âœ”";
  setTimeout(()=> btn.innerText="ç¡®è®¤æäº¤ (Enter)", 1000);
}

/* ================= REPORT & EXPORT (V6.6: æƒé™è¿‡æ»¤ä¸æ—¥æœŸè”åŠ¨) ================= */
function renderReport(startStr, endStr) {
  let tin=0, tout=0;
  
  // V6.6: ç§»é™¤ reportFilterï¼Œç°åœ¨æ ¹æ® dash-start/end æ¥è®¡ç®—
  document.querySelectorAll('.card > div:first-child > div:last-child button').forEach(btn => {
      btn.classList.remove('primary'); btn.classList.add('secondary');
  });

  if (!startStr || !endStr) {
      document.getElementById('rpt-in').innerText = '0.00';
      document.getElementById('rpt-out').innerText = '0.00';
      document.getElementById('rpt-net').innerText = '0.00';
      return;
  }
  
  // è¯†åˆ«å½“å‰ç‚¹å‡»çš„å¿«æ·æŒ‰é’®ï¼Œå¹¶é«˜äº®
  const today = new Date().toISOString().split('T')[0];
  const startMonth = new Date(startStr).toISOString().slice(0,7);
  if(startStr === today && endStr === today) {
      document.getElementById('btn-rpt-day').classList.add('primary');
  } else if (startStr.endsWith('-01') && new Date(endStr).toISOString().slice(0,7) === startMonth) {
      document.getElementById('btn-rpt-month').classList.add('primary');
  } // æš‚ä¸å¤„ç†å‘¨ï¼Œé¿å…å¤æ‚æ€§

  
  DB.entries.forEach(e => {
    // V6.6 æ ¸å¿ƒï¼šæƒé™è¿‡æ»¤
    const mainGroup = getAccGroup(e.mainId);
    const otherGroup = getAccGroup(e.otherId);
    if (!canUserViewGroup(mainGroup) && !canUserViewGroup(otherGroup)) {
        return; // è·³è¿‡æ— æƒæŸ¥çœ‹çš„äº¤æ˜“
    }
    
    if (e.date >= startStr && e.date <= endStr && e.type !== 'è½¬è´¦' && e.type !== 'æœŸåˆ' && !e.type.includes('å¢åŠ ')) {
        tin += (e.income||0); tout += (e.expense||0);
    }
  });

  document.getElementById('rpt-in').innerText = formatAmount(tin);
  document.getElementById('rpt-out').innerText = formatAmount(tout);
  document.getElementById('rpt-net').innerText = formatAmount(tin-tout);
}


function exportJSON() {
  if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥å¯¼å‡º JSONã€‚');
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `AG_Backup_${today()}_V6_7.json`;
  a.click();
}

function exportCSV() {
    const header = ["æ—¥æœŸ", "ç±»å‹", "è¯´æ˜", "æŸç›Šç±»åˆ«", "ä¸»è´¦æˆ·", "å¯¹æ–¹è´¦æˆ·", "æ”¶å…¥", "æ”¯å‡º", "æ“ä½œäºº", "æœ€åç¼–è¾‘æ—¶é—´", "äº¤æ˜“ID"];
    const entriesData = DB.entries.map(e => ({ ...e, mainAccName: getAccName(e.mainId), otherAccName: getAccName(e.otherId), plCategoryName: PL_CATEGORIES[e.plCategory] || e.plCategory || '-', mainGroup: getAccGroup(e.mainId), otherGroup: getAccGroup(e.otherId) }));
    const search = document.getElementById('search-input').value.toLowerCase();
    const startDate = document.getElementById('dash-start').value;
    const endDate = document.getElementById('dash-end').value;

    const filteredForExport = entriesData.filter(e => {
        // V6.6 æ ¸å¿ƒï¼šæƒé™è¿‡æ»¤ (å¯¼å‡ºæ•°æ®ä¹ŸæŒ‰æƒé™)
        if (!canUserViewGroup(e.mainGroup) && !canUserViewGroup(e.otherGroup)) return false;

        if (currentAccountFilterId && e.mainId !== currentAccountFilterId && e.otherId !== currentAccountFilterId) return false;
        if (startDate && e.date < startDate) return false;
        if (endDate && e.date > endDate) return false;
        if(search) {
            if (!e.desc.toLowerCase().includes(search) && !e.mainAccName.toLowerCase().includes(search) && !e.otherAccName.toLowerCase().includes(search)) return false;
        }
        return true;
    });

    const csvData = filteredForExport.map(e => [
        e.date, e.type, e.desc || '', e.plCategoryName, e.mainAccName, e.otherAccName, formatAmount(e.income), formatAmount(e.expense), e.operator, formatDateTime(e.editedAt), e.id
    ]);

    const csv = Papa.unparse({ fields: header, data: csvData });
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); 
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `AG_Ledger_Export_${today()}.csv`;
    a.click();
}

function exportPDF() {
    alert("PDF å¯¼å‡ºåŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ CSV å¯¼å‡ºä»¥é¿å…ä¹±ç é—®é¢˜ã€‚");
    return;
  /*
  const { jsPDF } = window.jspdf;
  // ç”±äº PDF å­—ä½“é—®é¢˜å¤æ‚ï¼Œæ­¤å¤„ä»…ä¿ç•™é€»è¾‘æ¡†æ¶ï¼Œå»ºè®®ä½¿ç”¨ CSV å¯¼å‡ºã€‚
  */
}

/* ================= MANAGER (V6.6: æƒé™è®¾ç½®ä¸å¤‡æ³¨) ================= */
function showManager() { 
  if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†ï¼');
  document.getElementById('modal-mgr').classList.remove('hidden'); 
  renderUsers(); 
}

function renderUsers() {
    const tbody = document.querySelector('#user-table tbody'); tbody.innerHTML='';
    DB.users.forEach(u => {
        const isSelf = u.id === currentUser.id;
        
        // æ¸²æŸ“æƒé™å¤é€‰æ¡†
        const checkboxHtml = Object.keys(GROUPS).map(groupKey => {
            const isChecked = u.allowedGroups && u.allowedGroups.includes(groupKey);
            return `<label style="display:block; margin: 3px 0;"><input type="checkbox" data-group="${groupKey}" ${isChecked ? 'checked' : ''} ${u.role === 'admin' ? 'disabled' : ''} onchange="updateUserPermissions('${u.id}', this)"> ${GROUPS[groupKey]}</label>`;
        }).join('');

        const nameDisplay = `<span style="font-weight:600;">${u.name}</span> <span style="font-size:11px; color:#666;">(${u.username})</span>`;
        const passInput = `<input type="password" id="user-pass-${u.id}" placeholder="****** (è¾“å…¥ä»¥ä¿®æ”¹)" onchange="updateUser('${u.id}', 'password', this.value)">`;
        const canDelete = !isSelf && u.role !== 'admin'; // ç®¡ç†å‘˜ä¸èƒ½åˆ é™¤è‡ªå·±ï¼Œä¹Ÿä¸èƒ½åˆ é™¤å…¶ä»–ç®¡ç†å‘˜

        tbody.innerHTML += `
        <tr>
            <td>${nameDisplay}</td>
            <td>
                <span style="font-weight:500; font-size:13px;">${ROLES[u.role] || u.role}</span>
                <span style="font-size:11px; color:var(--primary); display:block;">${u.remark || 'æ— å¤‡æ³¨'}</span>
                
                <details style="margin-top:5px; padding:5px; background:#f0f0f0; border-radius:4px;">
                    <summary style="cursor:pointer; font-size:11px; color:#333;">æƒé™èŒƒå›´</summary>
                    <div style="font-size:10px; margin-top:5px;">${checkboxHtml}</div>
                </details>
            </td>
            <td>${passInput}</td>
            <td>${canDelete ? `<button class="danger sm" onclick="delUser('${u.id}')">åˆ é™¤</button>` : '---'}</td>
        </tr>`;
    });
}

function updateUser(id, field, value) {
    const user = DB.users.find(u => u.id === id);
    if (!user) return;
    const trimmedValue = value.trim();
    if(field === 'password') {
        if (trimmedValue === '') return; 
        if (trimmedValue.length < 6) { alert("å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä½å­—ç¬¦ï¼"); renderUsers(); return; }
        user[field] = trimmedValue; 
    } else { user[field] = trimmedValue; }
    saveDB();
    if (currentUser.id === id) location.reload(); // æ›´æ”¹è‡ªèº«è§’è‰²/åç§°éœ€è¦é‡æ–°ç™»å½•æˆ–åˆ·æ–°
}

// V6.6 æ–°å¢ï¼šæ‰¹é‡æ›´æ–°ç”¨æˆ·æƒé™
function updateUserPermissions(id, checkbox) {
    if (currentUser.role !== 'admin') return alert('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹æƒé™ã€‚');
    const user = DB.users.find(u => u.id === id);
    if (!user || user.role === 'admin') return;

    const groupKey = checkbox.dataset.group;
    if (checkbox.checked) {
        if (!user.allowedGroups.includes(groupKey)) user.allowedGroups.push(groupKey);
    } else {
        user.allowedGroups = user.allowedGroups.filter(g => g !== groupKey);
    }
    saveDB();
    if (user.id === currentUser.id) {
        // å¦‚æœæ˜¯ä¿®æ”¹è‡ªå·±çš„æƒé™ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªåº”ç”¨
        renderApp();
    }
}


function addUser() {
  const name=document.getElementById('new-u-name').value.trim();
  const user=document.getElementById('new-u-user').value.trim();
  const pass=document.getElementById('new-u-pass').value.trim();
  const role=document.getElementById('new-u-role').value;
  const remark=document.getElementById('new-u-remark').value.trim(); // V6.6: è·å–å¤‡æ³¨
  
  if(!name || !user || !pass || !role) return alert("è¯·å¡«å†™å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯");
  if(DB.users.some(u => u.username.toLowerCase() === user.toLowerCase())) return alert("ç”¨æˆ·åå·²å­˜åœ¨ï¼");
  if(pass.length < 6) return alert("å¯†ç é•¿åº¦è‡³å°‘éœ€è¦ 6 ä½å­—ç¬¦ï¼"); 

  // V6.6: è·å–å‹¾é€‰çš„æƒé™
  let perms = [];
  document.querySelectorAll('#permission-checkboxes input:checked').forEach(cb => perms.push(cb.value));
  
  // ç®¡ç†å‘˜å¼ºåˆ¶æ‹¥æœ‰æ‰€æœ‰æƒé™
  if (role === 'admin') perms = DEFAULT_PERMS; 
  
  // ä»…åœ¨éç®¡ç†å‘˜è§’è‰²ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦è‡³å°‘å‹¾é€‰äº†ä¸€ä¸ªæƒé™
  if (role !== 'admin' && perms.length === 0) {
      if(!confirm("æ‚¨æœªå‹¾é€‰ä»»ä½•ä¸šåŠ¡æƒé™ã€‚è¯¥ç”¨æˆ·å°†çœ‹ä¸åˆ°ä»»ä½•äº¤æ˜“è®°å½•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ")) return;
  }

  DB.users.push({
      id:uuid(), name, username:user, password:pass, role:role,
      remark: remark, // V6.6: å­˜å…¥å¤‡æ³¨
      allowedGroups: perms // V6.6: å­˜å…¥æƒé™
  }); 

  saveDB(); renderUsers(); 
  document.getElementById('new-u-name').value = document.getElementById('new-u-user').value = document.getElementById('new-u-pass').value = document.getElementById('new-u-remark').value = '';
  document.querySelectorAll('#permission-checkboxes input').forEach(cb => cb.checked = false);
}

function delUser(id) { 
  if(!confirm("ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ")) return;
  DB.users = DB.users.filter(u=>u.id!==id); 
  saveDB(); renderUsers(); 
}

// åˆå§‹åŒ–æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæœ¬æœˆ
init();
if(document.getElementById('dash-start')) {
    const now = new Date();
    document.getElementById('dash-start').value = now.toISOString().slice(0,7) + '-01';
    document.getElementById('dash-end').value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
}

</script>
</body>
</html>
